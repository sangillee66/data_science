{
  "hash": "c93c2b9275a5f6b8257f1e0a617594ab",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Lab07: 데이터 수집하기\"\nauthor: \"이상일(서울대학교 지리교육과 교수), 김세창(사회교육과 지리전공 석사), 김우형(사회교육과 지리전공 석사과정)\"\ndate-modified: last-modified\nnumber-sections: true\nformat: \n  html: \n    toc: true\n    embed-resources: false\ncode-link: true\ncode-copy: true\nexecute: \n  warning: false\n  error: false\n  freeze: auto\neditor: visual\nbibliography: references.bib\n---\n\n## 실습 개요 {.unnumbered}\n\n이 실습은 R로 데이터를 수집하는 과정을 다룬다. R을 활용한 데이터 수집은 다양한 방법으로 진행될 수 있지만 여기서는 웹상의 데이터 파일 불러오기, 웹 스크레이핑, API를 이용하는 방식에 집중한다. 실습의 시작은 [`tidyverse`](https://www.tidyverse.org/) 패키지를 불러오는 것이다.\n\n## 웹상의 데이터 파일 불러오기\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n\n아마도 데이터를 수집하는 가장 단순한 방법은 웹상에 파일 형태로 존재하는 데이터를 R에서 불러오는 것일 것이다. `readr` 패키지에서 제공하는 다양한 데이터 불러오기 함수(예: [`read_csv()`](https://readr.tidyverse.org/reference/read_delim.html))를 데이터의 URL에 적용하면 손쉽게 데이터를 획득할 수 있다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstudents <- read_csv(\"https://pos.it/r4ds-students-csv\")\nstudents\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  `Student ID` `Full Name`      favourite.food     mealPlan            AGE  \n         <dbl> <chr>            <chr>              <chr>               <chr>\n1            1 Sunil Huffmann   Strawberry yoghurt Lunch only          4    \n2            2 Barclay Lynn     French fries       Lunch only          5    \n3            3 Jayendra Lyne    N/A                Breakfast and lunch 7    \n4            4 Leon Rossini     Anchovies          Lunch only          <NA> \n5            5 Chidiegwu Dunkel Pizza              Breakfast and lunch five \n6            6 Güvenç Attila    Ice cream          Lunch only          6    \n```\n\n\n:::\n:::\n\n\n그런데 엑셀 형식의 파일은 [`readxl`](https://readxl.tidyverse.org/) 패키지가 제공하는 [`read_excel()`](https://readxl.tidyverse.org/reference/read_excel.html) 함수를 이용해 막바로 데이터를 불러오는 것이 불가능하다. [`openxlsx`](https://ycphs.github.io/openxlsx/) 패키지는 이러한 문제를 해결할 수 있게 해준다. 정말 다양한 함수를 제공하지만 [`read.xlsx()`](https://rdrr.io/pkg/openxlsx/man/read.xlsx.html) 함수가 URL을 통해 엑셀 데이터를 불러오는데 사용된다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\nxlsx_data <- read.xlsx(\"https://github.com/awalker89/openxlsx/raw/master/inst/readTest.xlsx\")\nxlsx_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Var1 Var2   Var3 Var4  Var5         Var6 Var7\n1   TRUE    1   1.00    a 42042 3209324 This   NA\n2   TRUE   NA     NA    b 42041         <NA>   NA\n3   TRUE    2   1.34    c 42040         <NA>   NA\n4  FALSE    2     NA <NA>    NA         <NA>   NA\n5  FALSE    3   1.56    e    NA         <NA>   NA\n6  FALSE    1   1.70    f 42037         <NA>   NA\n7     NA   NA     NA <NA> 42036         <NA>   NA\n8  FALSE    2  23.00    h 42035         <NA>   NA\n9  FALSE    3  67.30    i 42034         <NA>   NA\n10    NA    1 123.00 <NA> 42033         <NA>   NA\n```\n\n\n:::\n:::\n\n\n## 웹스크레이핑\n\n웹스크레이핑(web scraping)이란 웹페이지로부터 특정한 데이터를 추출하는 것을 의미한다. R에서 웹스크레이핑은 `rvest` 패키지가 답당하는데, `reaxl` 패키지와 마찬가지로 `tidyverse`의 핵심 패키지는 아니기 때문에 따로 불러와야 한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\n```\n:::\n\n\n### 웹스크레이핑의 실제 1: 테이블이 하나 있는 경우\n\n위키피디어의 한 항목(List of countries and dependencies by population)에는 표 하나가 포함되어 있다. 해당 표의 데이터를 수집한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\nurl <- \"https://en.wikipedia.org/wiki/List_of_countries_and_dependencies_by_population\"\nmy_table <- url |> \n  read_html() |> \n  html_element(\"table\") |> \n  html_table()\nmy_table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 240 × 6\n   Location      Population    `% ofworld` Date     Source (official or …¹ Notes\n   <chr>         <chr>         <chr>       <chr>    <chr>                  <chr>\n 1 World         8,232,000,000 100%        13 Jun … UN projection[1][3]    \"\"   \n 2 India         1,417,492,000 17.2%       1 Jul 2… Official projection[4] \"[b]\"\n 3 China         1,408,280,000 17.1%       31 Dec … Official estimate[5]   \"[c]\"\n 4 United States 340,110,988   4.1%        1 Jul 2… Official estimate[6]   \"[d]\"\n 5 Indonesia     284,438,782   3.5%        30 Jun … National annual proje… \"\"   \n 6 Pakistan      241,499,431   2.9%        1 Mar 2… 2023 census result[8]  \"[e]\"\n 7 Nigeria       223,800,000   2.7%        1 Jul 2… Official projection[9] \"\"   \n 8 Brazil        213,421,037   2.6%        1 Jul 2… Official estimate[10]  \"\"   \n 9 Bangladesh    169,828,911   2.1%        14 Jun … 2022 census result[11] \"[f]\"\n10 Russia        146,028,325   1.8%        1 Jan 2… Official estimate[13]  \"[g]\"\n# ℹ 230 more rows\n# ℹ abbreviated name: ¹​`Source (official or fromthe United Nations)`\n```\n\n\n:::\n:::\n\n\n수집한 데이터를 가공해본다. 필요없는 컬럼을 제거하고, 컬럼 이름을 바꾸고, 몇몇 변수를 특정 형태의 타입(numeric, date)으로 변환하기 위한 과정이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_table <- my_table |> \n  select(-6) |> \n  rename(\n    location = \"Location\",\n    population = \"Population\",\n    pop_pct = \"% ofworld\",\n    date = \"Date\",\n    source = \"Source (official or fromthe United Nations)\"\n  ) |> \n  mutate(\n    population = str_remove_all(population, \",\"),\n    population = as.numeric(population),\n    pop_pct = str_remove(pop_pct, \"%\"),\n    pop_pct = as.numeric(pop_pct),\n    date = dmy(date)\n  )\n\nmy_table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 240 × 5\n   location      population pop_pct date       source                       \n   <chr>              <dbl>   <dbl> <date>     <chr>                        \n 1 World         8232000000   100   2025-06-13 UN projection[1][3]          \n 2 India         1417492000    17.2 2025-07-01 Official projection[4]       \n 3 China         1408280000    17.1 2024-12-31 Official estimate[5]         \n 4 United States  340110988     4.1 2024-07-01 Official estimate[6]         \n 5 Indonesia      284438782     3.5 2025-06-30 National annual projection[7]\n 6 Pakistan       241499431     2.9 2023-03-01 2023 census result[8]        \n 7 Nigeria        223800000     2.7 2023-07-01 Official projection[9]       \n 8 Brazil         213421037     2.6 2025-07-01 Official estimate[10]        \n 9 Bangladesh     169828911     2.1 2022-06-14 2022 census result[11]       \n10 Russia         146028325     1.8 2025-01-01 Official estimate[13]        \n# ℹ 230 more rows\n```\n\n\n:::\n:::\n\n\n### 웹스크레이핑의 실제 2: 테이블이 둘 이상인 경우\n\n위키피디아의 한 항목(List of FIPS country codes)에는 동일한 내용에 대해 여러 개의 표가 나타나 있다. 개별 표의 데이터를 수집한 후 결합하여 단일한 데이터 프레임을 구성한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://en.wikipedia.org/wiki/List_of_FIPS_country_codes\"\nmy_tables <- url |> \n  read_html() |> \n  html_elements(\"table\") |> \n  html_table() |> \n  bind_rows()\nmy_tables\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 277 × 10\n   Code    `Short-form name` .mw-parser-output .n…¹ .mw-parser-output .n…² ...3 \n   <chr>   <chr>             <chr>                  <chr>                  <chr>\n 1 .mw-pa… Aruba             <NA>                   <NA>                   <NA> \n 2 AC      Antigua and Barb… <NA>                   <NA>                   <NA> \n 3 AD      Akrotiri          <NA>                   <NA>                   <NA> \n 4 AE      United Arab Emir… <NA>                   <NA>                   <NA> \n 5 AF      Afghanistan       <NA>                   <NA>                   <NA> \n 6 AG      Algeria           <NA>                   <NA>                   <NA> \n 7 AJ      Azerbaijan        <NA>                   <NA>                   <NA> \n 8 AL      Albania           <NA>                   <NA>                   <NA> \n 9 AM      Armenia           <NA>                   <NA>                   <NA> \n10 AN      Andorra           <NA>                   <NA>                   <NA> \n# ℹ 267 more rows\n# ℹ abbreviated names:\n#   ¹​`.mw-parser-output .navbar{display:inline;font-size:88%;font-weight:normal}.mw-parser-output .navbar-collapse{float:left;text-align:left}.mw-parser-output .navbar-boxtext{word-spacing:0}.mw-parser-output .navbar ul{display:inline-block;white-space:nowrap;line-height:inherit}.mw-parser-output .navbar-brackets::before{margin-right:-0.125em;content:\"[ \"}.mw-parser-output .navbar-brackets::after{margin-left:-0.125em;content:\" ]\"}.mw-parser-output .navbar li{word-spacing:-0.125em}.mw-parser-output .navbar a>span,.mw-parser-output .navbar a>abbr{text-decoration:inherit}.mw-parser-output .navbar-mini abbr{font-variant:small-caps;border-bottom:none;text-decoration:none;cursor:inherit}.mw-parser-output .navbar-ct-full{font-size:114%;margin:0 7em}.mw-parser-output .navbar-ct-mini{font-size:114%;margin:0 4em}html.skin-theme-clientpref-night .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}@media(prefers-color-scheme:dark){html.skin-theme-clientpref-os .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}}@media print{.mw-parser-output .navbar{display:none!important}}vteGeocode systems...1`,\n#   ²​`.mw-parser-output .navbar{display:inline;font-size:88%;font-weight:normal}.mw-parser-output .navbar-collapse{float:left;text-align:left}.mw-parser-output .navbar-boxtext{word-spacing:0}.mw-parser-output .navbar ul{display:inline-block;white-space:nowrap;line-height:inherit}.mw-parser-output .navbar-brackets::before{margin-right:-0.125em;content:\"[ \"}.mw-parser-output .navbar-brackets::after{margin-left:-0.125em;content:\" ]\"}.mw-parser-output .navbar li{word-spacing:-0.125em}.mw-parser-output .navbar a>span,.mw-parser-output .navbar a>abbr{text-decoration:inherit}.mw-parser-output .navbar-mini abbr{font-variant:small-caps;border-bottom:none;text-decoration:none;cursor:inherit}.mw-parser-output .navbar-ct-full{font-size:114%;margin:0 7em}.mw-parser-output .navbar-ct-mini{font-size:114%;margin:0 4em}html.skin-theme-clientpref-night .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}@media(prefers-color-scheme:dark){html.skin-theme-clientpref-os .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}}@media print{.mw-parser-output .navbar{display:none!important}}vteGeocode systems...2`\n# ℹ 5 more variables: ...4 <chr>, ...5 <chr>, ...6 <chr>, X1 <chr>, X2 <chr>\n```\n\n\n:::\n:::\n\n\n수집한 데이터를 약간 가공한다. 역시 필요한 컬럼만 남기고, 이름을 바꿔준다. 마지막 `str_extract`는 Aruba의 단축어에 원치 않는 문자열이 추가되어 있어 제거하기 위한 코드이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_tables <- my_tables |> \n  select(1, 2) |> \n  rename(\n    code = \"Code\", \n    short_name = \"Short-form name\"\n  ) |> \n  mutate(\n    code = str_extract(code, \"[A-Z][A-Z]\")\n  )\nmy_tables\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 277 × 2\n   code  short_name          \n   <chr> <chr>               \n 1 AA    Aruba               \n 2 AC    Antigua and Barbuda \n 3 AD    Akrotiri            \n 4 AE    United Arab Emirates\n 5 AF    Afghanistan         \n 6 AG    Algeria             \n 7 AJ    Azerbaijan          \n 8 AL    Albania             \n 9 AM    Armenia             \n10 AN    Andorra             \n# ℹ 267 more rows\n```\n\n\n:::\n:::\n\n\n::: {.callout-tip collapse=\"false\"}\n## 추가 예제\n\n간혹 테이블을 불러올 때 데이터가 깨지는 경우도 발생한다. 이는 인코딩 방식의 문제인데, 아래와 같이 인코딩 아규먼트를 추가하면 해결된다. 보통 \"EUC-KR\"이나 \"UTF-8\" 둘 중 하나는 제대로 작동한다.\n\n한 번 네이버가 제공하는 주식 거래 상위 품목을 크롤링해보자.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(DT)\nkospi <- \"https://finance.naver.com/sise/sise_quant.naver?sosok=0\"\n\nkospi_table <- kospi |> \n  read_html(, encoding = \"EUC-KR\") |> \n  html_elements(\"table\") |> \n  html_table() |> \n  _[[2]] |> \n  filter(is.na(N) == FALSE)\n\ndatatable(kospi_table)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-9d00c672f0de0f38dd71\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-9d00c672f0de0f38dd71\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\",\"69\",\"70\",\"71\",\"72\",\"73\",\"74\",\"75\",\"76\",\"77\",\"78\",\"79\",\"80\",\"81\",\"82\",\"83\",\"84\",\"85\",\"86\",\"87\",\"88\",\"89\",\"90\",\"91\",\"92\",\"93\",\"94\",\"95\",\"96\",\"97\",\"98\",\"99\",\"100\"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100],[\"KODEX 200선물인버스2X\",\"KODEX 인버스\",\"티엠씨\",\"KODEX 2차전지산업레버리지\",\"삼성전자\",\"KODEX 코스닥150선물인버스\",\"KODEX 레버리지\",\"KODEX 코스닥150레버리지\",\"디아이씨\",\"대원전선\",\"TIGER 200선물인버스2X\",\"삼성 인버스 2X WTI원유 선물 ETN\",\"KODEX 200\",\"한화시스템\",\"경방\",\"대한전선\",\"TIGER 미국S&amp;P500\",\"TIGER 2차전지소재Fn\",\"일동제약\",\"대한제당\",\"KODEX 미국S&amp;P500\",\"TIGER 반도체TOP10\",\"현대건설\",\"YG PLUS\",\"두산에너빌리티\",\"TIGER 리츠부동산인프라\",\"삼성 인버스 2X 코스닥150 선물 ETN\",\"삼성 레버리지 WTI원유 선물 ETN\",\"일성건설\",\"KODEX 코스닥150\",\"대한제당우\",\"에이블씨엔씨\",\"KODEX 200타겟위클리커버드콜\",\"포스코DX\",\"에이프로젠\",\"TIGER 2차전지TOP10레버리지\",\"KCTC\",\"삼성제약\",\"KODEX 반도체레버리지\",\"신한 인버스 2X WTI원유 선물 ETN(H)\",\"KODEX 미국AI전력핵심인프라\",\"삼성 레버리지 천연가스 선물 ETN C\",\"현대약품\",\"HJ중공업\",\"삼성전자우\",\"한국전력\",\"태림포장\",\"세이브존I&amp;C\",\"진흥기업\",\"세아베스틸지주\",\"KODEX 미국나스닥100\",\"ACE KRX금현물\",\"KODEX 은선물(H)\",\"SK하이닉스\",\"TIGER 화장품\",\"미래에셋증권\",\"KODEX AI전력핵심설비\",\"TIGER 코리아원자력\",\"티웨이홀딩스\",\"삼성중공업\",\"한온시스템\",\"TIGER 200\",\"동양\",\"TIGER 미국테크TOP10 INDXX\",\"한화생명\",\"ACE 미국30년국채액티브(H)\",\"이수페타시스\",\"ACE 미국AI테크핵심산업액티브\",\"SG세계물산\",\"미래아이앤지\",\"RISE AI&amp;로봇\",\"ACE 테슬라밸류체인액티브\",\"TIGER 미국AI전력SMR\",\"TIGER 코리아AI전력기기TOP3플러스\",\"KODEX 반도체\",\"KODEX 2차전지산업\",\"1Q 미국우주항공테크\",\"TIGER 미국30년국채커버드콜액티브(H)\",\"HANARO Fn K-반도체\",\"우진\",\"TIGER 미국필라델피아반도체나스닥\",\"대성산업\",\"한올바이오파마\",\"대우건설\",\"HD현대인프라코어\",\"RISE 200위클리커버드콜\",\"코람코더원리츠\",\"KODEX 2차전지핵심소재10\",\"카카오\",\"KODEX 한국부동산리츠인프라\",\"TIGER KRX금현물\",\"ACE 엔비디아밸류체인액티브\",\"대한해운\",\"삼성에피스홀딩스\",\"KODEX 삼성전자채권혼합\",\"TIGER 바이오TOP10\",\"KoAct 바이오헬스케어액티브\",\"TIGER 미국배당다우존스\",\"TIGER 반도체TOP10레버리지\",\"LG디스플레이\"],[\"690\",\"2,575\",\"16,770\",\"1,757\",\"104,800\",\"2,870\",\"43,005\",\"12,040\",\"13,940\",\"4,075\",\"730\",\"94\",\"57,655\",\"52,700\",\"11,990\",\"24,400\",\"25,015\",\"6,230\",\"40,850\",\"3,035\",\"22,915\",\"18,045\",\"73,100\",\"6,540\",\"77,100\",\"4,460\",\"3,365\",\"1,118\",\"2,660\",\"15,810\",\"2,855\",\"11,200\",\"13,175\",\"28,950\",\"768\",\"1,597\",\"6,640\",\"1,744\",\"24,950\",\"74\",\"17,775\",\"2,735\",\"6,330\",\"23,200\",\"81,000\",\"50,000\",\"2,065\",\"3,395\",\"729\",\"48,950\",\"24,735\",\"28,940\",\"10,800\",\"554,000\",\"3,345\",\"21,450\",\"24,125\",\"11,005\",\"514\",\"25,700\",\"3,560\",\"57,685\",\"834\",\"30,935\",\"3,130\",\"7,660\",\"130,800\",\"8,550\",\"362\",\"896\",\"13,685\",\"22,500\",\"7,965\",\"12,935\",\"56,095\",\"16,040\",\"12,600\",\"7,695\",\"19,220\",\"19,960\",\"27,380\",\"7,790\",\"44,300\",\"3,765\",\"17,020\",\"10,650\",\"8,290\",\"6,155\",\"59,600\",\"4,845\",\"13,850\",\"14,440\",\"1,875\",\"709,000\",\"12,765\",\"9,020\",\"23,595\",\"13,070\",\"14,595\",\"12,300\"],[\"상승\\n\\t\\t\\t\\t30\",\"상승\\n\\t\\t\\t\\t60\",\"상승\\n\\t\\t\\t\\t7,470\",\"하락\\n\\t\\t\\t\\t10\",\"하락\\n\\t\\t\\t\\t4,100\",\"상승\\n\\t\\t\\t\\t5\",\"하락\\n\\t\\t\\t\\t2,060\",\"하락\\n\\t\\t\\t\\t40\",\"상승\\n\\t\\t\\t\\t1,890\",\"하락\\n\\t\\t\\t\\t85\",\"상승\\n\\t\\t\\t\\t31\",\"상승\\n\\t\\t\\t\\t2\",\"하락\\n\\t\\t\\t\\t1,340\",\"하락\\n\\t\\t\\t\\t400\",\"상승\\n\\t\\t\\t\\t980\",\"상승\\n\\t\\t\\t\\t400\",\"하락\\n\\t\\t\\t\\t265\",\"상승\\n\\t\\t\\t\\t30\",\"하락\\n\\t\\t\\t\\t3,450\",\"상승\\n\\t\\t\\t\\t115\",\"하락\\n\\t\\t\\t\\t245\",\"하락\\n\\t\\t\\t\\t580\",\"하락\\n\\t\\t\\t\\t4,900\",\"상승\\n\\t\\t\\t\\t100\",\"하락\\n\\t\\t\\t\\t2,600\",\"하락\\n\\t\\t\\t\\t20\",\"상승\\n\\t\\t\\t\\t20\",\"하락\\n\\t\\t\\t\\t16\",\"상승\\n\\t\\t\\t\\t70\",\"하락\\n\\t\\t\\t\\t15\",\"상승\\n\\t\\t\\t\\t340\",\"상승\\n\\t\\t\\t\\t2,070\",\"하락\\n\\t\\t\\t\\t255\",\"상승\\n\\t\\t\\t\\t1,250\",\"하락\\n\\t\\t\\t\\t18\",\"하락\\n\\t\\t\\t\\t11\",\"하락\\n\\t\\t\\t\\t70\",\"하락\\n\\t\\t\\t\\t108\",\"하락\\n\\t\\t\\t\\t1,560\",\"상승\\n\\t\\t\\t\\t1\",\"하락\\n\\t\\t\\t\\t1,150\",\"하락\\n\\t\\t\\t\\t150\",\"상승\\n\\t\\t\\t\\t240\",\"하락\\n\\t\\t\\t\\t1,000\",\"하락\\n\\t\\t\\t\\t1,700\",\"상승\\n\\t\\t\\t\\t250\",\"상승\\n\\t\\t\\t\\t96\",\"하락\\n\\t\\t\\t\\t230\",\"보합0\",\"상승\\n\\t\\t\\t\\t4,200\",\"하락\\n\\t\\t\\t\\t435\",\"상승\\n\\t\\t\\t\\t425\",\"하락\\n\\t\\t\\t\\t140\",\"하락\\n\\t\\t\\t\\t17,000\",\"보합0\",\"하락\\n\\t\\t\\t\\t750\",\"하락\\n\\t\\t\\t\\t735\",\"하락\\n\\t\\t\\t\\t555\",\"상승\\n\\t\\t\\t\\t44\",\"하락\\n\\t\\t\\t\\t600\",\"하락\\n\\t\\t\\t\\t45\",\"하락\\n\\t\\t\\t\\t1,360\",\"하락\\n\\t\\t\\t\\t13\",\"하락\\n\\t\\t\\t\\t565\",\"상승\\n\\t\\t\\t\\t25\",\"하락\\n\\t\\t\\t\\t40\",\"하락\\n\\t\\t\\t\\t4,300\",\"하락\\n\\t\\t\\t\\t665\",\"보합0\",\"상승\\n\\t\\t\\t\\t75\",\"상승\\n\\t\\t\\t\\t65\",\"상승\\n\\t\\t\\t\\t175\",\"하락\\n\\t\\t\\t\\t590\",\"하락\\n\\t\\t\\t\\t450\",\"하락\\n\\t\\t\\t\\t1,280\",\"하락\\n\\t\\t\\t\\t45\",\"하락\\n\\t\\t\\t\\t250\",\"하락\\n\\t\\t\\t\\t40\",\"하락\\n\\t\\t\\t\\t575\",\"하락\\n\\t\\t\\t\\t1,690\",\"하락\\n\\t\\t\\t\\t1,210\",\"하락\\n\\t\\t\\t\\t310\",\"상승\\n\\t\\t\\t\\t1,750\",\"하락\\n\\t\\t\\t\\t125\",\"상승\\n\\t\\t\\t\\t80\",\"하락\\n\\t\\t\\t\\t195\",\"상승\\n\\t\\t\\t\\t290\",\"상승\\n\\t\\t\\t\\t20\",\"하락\\n\\t\\t\\t\\t200\",\"하락\\n\\t\\t\\t\\t30\",\"상승\\n\\t\\t\\t\\t225\",\"하락\\n\\t\\t\\t\\t950\",\"하락\\n\\t\\t\\t\\t22\",\"상승\\n\\t\\t\\t\\t48,000\",\"하락\\n\\t\\t\\t\\t145\",\"상승\\n\\t\\t\\t\\t210\",\"상승\\n\\t\\t\\t\\t460\",\"상승\\n\\t\\t\\t\\t15\",\"하락\\n\\t\\t\\t\\t750\",\"하락\\n\\t\\t\\t\\t220\"],[\"+4.55%\",\"+2.39%\",\"+80.32%\",\"-0.57%\",\"-3.76%\",\"+0.17%\",\"-4.57%\",\"-0.33%\",\"+15.68%\",\"-2.04%\",\"+4.43%\",\"+2.17%\",\"-2.27%\",\"-0.75%\",\"+8.90%\",\"+1.67%\",\"-1.05%\",\"+0.48%\",\"-7.79%\",\"+3.94%\",\"-1.06%\",\"-3.11%\",\"-6.28%\",\"+1.55%\",\"-3.26%\",\"-0.45%\",\"+0.60%\",\"-1.41%\",\"+2.70%\",\"-0.09%\",\"+13.52%\",\"+22.67%\",\"-1.90%\",\"+4.51%\",\"-2.29%\",\"-0.68%\",\"-1.04%\",\"-5.83%\",\"-5.88%\",\"+1.37%\",\"-6.08%\",\"-5.20%\",\"+3.94%\",\"-4.13%\",\"-2.06%\",\"+0.50%\",\"+4.88%\",\"-6.34%\",\"0.00%\",\"+9.39%\",\"-1.73%\",\"+1.49%\",\"-1.28%\",\"-2.98%\",\"0.00%\",\"-3.38%\",\"-2.96%\",\"-4.80%\",\"+9.36%\",\"-2.28%\",\"-1.25%\",\"-2.30%\",\"-1.53%\",\"-1.79%\",\"+0.81%\",\"-0.52%\",\"-3.18%\",\"-7.22%\",\"0.00%\",\"+9.14%\",\"+0.48%\",\"+0.78%\",\"-6.90%\",\"-3.36%\",\"-2.23%\",\"-0.28%\",\"-1.95%\",\"-0.52%\",\"-2.90%\",\"-7.81%\",\"-4.23%\",\"-3.83%\",\"+4.11%\",\"-3.21%\",\"+0.47%\",\"-1.80%\",\"+3.63%\",\"+0.33%\",\"-0.33%\",\"-0.62%\",\"+1.65%\",\"-6.17%\",\"-1.16%\",\"+7.26%\",\"-1.12%\",\"+2.38%\",\"+1.99%\",\"+0.11%\",\"-4.89%\",\"-1.76%\"],[\"740,517,767\",\"43,717,753\",\"29,401,344\",\"26,430,149\",\"20,317,066\",\"19,235,032\",\"19,022,448\",\"16,523,323\",\"10,368,495\",\"10,149,222\",\"8,759,696\",\"8,664,288\",\"6,824,310\",\"6,628,720\",\"6,374,458\",\"5,541,513\",\"5,377,010\",\"5,160,103\",\"5,053,636\",\"4,969,161\",\"4,920,882\",\"4,681,615\",\"4,559,982\",\"4,428,581\",\"4,273,057\",\"4,263,395\",\"4,053,099\",\"3,894,664\",\"3,867,916\",\"3,781,036\",\"3,751,287\",\"3,679,649\",\"3,627,774\",\"3,552,660\",\"3,542,409\",\"3,448,937\",\"3,152,898\",\"3,046,561\",\"2,980,103\",\"2,956,505\",\"2,890,365\",\"2,857,994\",\"2,735,347\",\"2,719,125\",\"2,658,315\",\"2,626,829\",\"2,582,988\",\"2,551,976\",\"2,545,976\",\"2,538,197\",\"2,532,658\",\"2,482,814\",\"2,465,516\",\"2,465,509\",\"2,461,961\",\"2,444,403\",\"2,415,213\",\"2,375,096\",\"2,337,550\",\"2,308,471\",\"2,294,670\",\"2,262,556\",\"2,230,843\",\"2,189,899\",\"2,185,921\",\"2,129,044\",\"2,121,476\",\"2,012,594\",\"2,010,106\",\"2,001,391\",\"1,935,865\",\"1,918,145\",\"1,906,072\",\"1,891,226\",\"1,890,758\",\"1,883,788\",\"1,845,318\",\"1,843,937\",\"1,801,198\",\"1,798,225\",\"1,784,054\",\"1,743,085\",\"1,718,294\",\"1,702,681\",\"1,663,975\",\"1,659,341\",\"1,655,229\",\"1,645,534\",\"1,641,675\",\"1,635,531\",\"1,612,992\",\"1,581,806\",\"1,579,991\",\"1,579,423\",\"1,549,240\",\"1,548,322\",\"1,500,287\",\"1,483,883\",\"1,463,592\",\"1,453,674\"],[\"510,069\",\"112,450\",\"595,940\",\"46,145\",\"2,136,214\",\"55,524\",\"820,733\",\"196,012\",\"141,012\",\"40,854\",\"6,395\",\"814\",\"394,271\",\"367,959\",\"85,122\",\"132,939\",\"134,842\",\"31,937\",\"209,482\",\"15,156\",\"112,991\",\"84,323\",\"324,952\",\"29,994\",\"328,806\",\"18,975\",\"13,816\",\"4,354\",\"10,442\",\"59,391\",\"10,554\",\"41,719\",\"47,816\",\"104,246\",\"2,764\",\"5,480\",\"21,603\",\"5,396\",\"73,866\",\"218\",\"51,264\",\"7,994\",\"17,166\",\"63,819\",\"213,857\",\"131,272\",\"5,416\",\"9,240\",\"1,850\",\"126,824\",\"62,750\",\"71,655\",\"26,305\",\"1,358,604\",\"8,232\",\"52,589\",\"57,989\",\"26,028\",\"1,196\",\"59,604\",\"8,132\",\"130,874\",\"1,876\",\"67,828\",\"6,842\",\"16,302\",\"276,590\",\"17,292\",\"728\",\"1,874\",\"26,466\",\"43,142\",\"15,211\",\"24,430\",\"105,580\",\"30,055\",\"23,247\",\"14,174\",\"34,623\",\"35,593\",\"48,792\",\"14,361\",\"76,262\",\"6,428\",\"28,373\",\"17,693\",\"14,043\",\"10,038\",\"98,271\",\"7,931\",\"22,270\",\"22,865\",\"2,965\",\"1,090,178\",\"19,734\",\"13,831\",\"35,022\",\"19,405\",\"21,106\",\"17,867\"],[\"689\",\"2,570\",\"16,760\",\"1,756\",\"104,800\",\"2,865\",\"43,000\",\"12,035\",\"13,940\",\"4,075\",\"729\",\"93\",\"57,650\",\"52,700\",\"11,980\",\"24,350\",\"25,010\",\"6,230\",\"40,800\",\"3,035\",\"22,915\",\"18,045\",\"73,000\",\"6,530\",\"77,100\",\"4,455\",\"3,365\",\"1,117\",\"2,660\",\"15,805\",\"2,850\",\"11,200\",\"13,170\",\"28,900\",\"768\",\"1,596\",\"6,640\",\"1,744\",\"24,950\",\"74\",\"17,770\",\"2,730\",\"6,320\",\"23,150\",\"81,000\",\"50,000\",\"2,060\",\"3,395\",\"729\",\"48,900\",\"24,730\",\"28,940\",\"10,795\",\"553,000\",\"3,345\",\"21,450\",\"24,120\",\"11,005\",\"513\",\"25,650\",\"3,560\",\"57,680\",\"834\",\"30,930\",\"3,130\",\"7,660\",\"130,800\",\"8,550\",\"361\",\"895\",\"13,680\",\"22,500\",\"7,960\",\"12,930\",\"56,090\",\"16,035\",\"12,595\",\"7,690\",\"19,220\",\"19,960\",\"27,375\",\"7,790\",\"44,250\",\"3,765\",\"17,020\",\"10,645\",\"8,290\",\"6,155\",\"59,600\",\"4,845\",\"13,850\",\"14,435\",\"1,874\",\"709,000\",\"12,755\",\"9,015\",\"23,595\",\"13,070\",\"14,550\",\"12,290\"],[\"690\",\"2,575\",\"16,770\",\"1,757\",\"104,900\",\"2,870\",\"43,005\",\"12,040\",\"13,950\",\"4,080\",\"730\",\"94\",\"57,655\",\"52,800\",\"11,990\",\"24,400\",\"25,015\",\"6,235\",\"40,850\",\"3,040\",\"22,920\",\"18,060\",\"73,100\",\"6,540\",\"77,200\",\"4,460\",\"3,370\",\"1,118\",\"2,665\",\"15,810\",\"2,855\",\"11,210\",\"13,175\",\"28,950\",\"769\",\"1,597\",\"6,650\",\"1,745\",\"24,970\",\"75\",\"17,775\",\"2,735\",\"6,330\",\"23,200\",\"81,100\",\"50,100\",\"2,065\",\"3,425\",\"730\",\"48,950\",\"24,735\",\"28,945\",\"10,800\",\"554,000\",\"3,350\",\"21,500\",\"24,125\",\"11,010\",\"514\",\"25,700\",\"3,565\",\"57,685\",\"835\",\"30,935\",\"3,135\",\"7,665\",\"130,900\",\"8,555\",\"362\",\"896\",\"13,685\",\"22,505\",\"7,965\",\"12,935\",\"56,095\",\"16,040\",\"12,600\",\"7,695\",\"19,270\",\"19,970\",\"27,380\",\"7,800\",\"44,300\",\"3,780\",\"17,040\",\"10,650\",\"8,300\",\"6,160\",\"59,700\",\"4,850\",\"13,855\",\"14,440\",\"1,875\",\"710,000\",\"12,765\",\"9,020\",\"23,600\",\"13,075\",\"14,595\",\"12,300\"],[\"15,699\",\"8,024\",\"4,041\",\"5,861\",\"6,203,781\",\"2,259\",\"33,587\",\"17,675\",\"5,421\",\"3,141\",\"658\",\"1,407\",\"108,449\",\"99,561\",\"3,287\",\"45,493\",\"122,686\",\"7,865\",\"12,924\",\"2,722\",\"67,198\",\"18,180\",\"81,401\",\"4,164\",\"493,873\",\"10,539\",\"1,346\",\"4,517\",\"1,437\",\"14,134\",\"185\",\"2,914\",\"17,641\",\"44,014\",\"2,529\",\"1,528\",\"1,992\",\"1,642\",\"3,505\",\"468\",\"14,815\",\"1,368\",\"2,026\",\"20,949\",\"660,939\",\"320,982\",\"1,462\",\"1,393\",\"1,060\",\"17,554\",\"44,820\",\"35,567\",\"3,726\",\"4,033,133\",\"4,041\",\"122,333\",\"11,073\",\"2,344\",\"582\",\"226,160\",\"24,164\",\"43,841\",\"1,991\",\"41,035\",\"27,185\",\"22,015\",\"96,019\",\"1,894\",\"733\",\"259\",\"2,778\",\"13,174\",\"1,577\",\"3,751\",\"15,090\",\"17,002\",\"170\",\"13,039\",\"8,524\",\"4,031\",\"32,418\",\"3,524\",\"23,143\",\"15,648\",\"32,142\",\"5,879\",\"3,349\",\"2,591\",\"263,685\",\"5,569\",\"9,501\",\"2,238\",\"6,052\",\"176,421\",\"2,234\",\"2,945\",\"4,979\",\"22,853\",\"1,525\",\"61,500\"],[\"N/A\",\"N/A\",\"35.01\",\"N/A\",\"21.76\",\"N/A\",\"N/A\",\"N/A\",\"115.21\",\"28.70\",\"N/A\",\"N/A\",\"N/A\",\"16.72\",\"7.54\",\"102.09\",\"N/A\",\"N/A\",\"42.07\",\"5.06\",\"N/A\",\"N/A\",\"-30.83\",\"19.18\",\"-484.91\",\"N/A\",\"N/A\",\"N/A\",\"-2.48\",\"N/A\",\"4.76\",\"26.17\",\"N/A\",\"59.57\",\"-4.68\",\"N/A\",\"8.97\",\"3.08\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"263.75\",\"-116.00\",\"16.82\",\"3.90\",\"-9.93\",\"13.86\",\"11.76\",\"437.05\",\"N/A\",\"N/A\",\"N/A\",\"11.30\",\"N/A\",\"12.31\",\"N/A\",\"N/A\",\"-0.73\",\"64.25\",\"-8.20\",\"N/A\",\"-2.56\",\"N/A\",\"3.50\",\"N/A\",\"66.40\",\"N/A\",\"-18.10\",\"-2.06\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"32.83\",\"N/A\",\"-39.74\",\"1,006.82\",\"-56.19\",\"23.80\",\"N/A\",\"145.44\",\"N/A\",\"113.52\",\"N/A\",\"N/A\",\"N/A\",\"4.17\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"-18.33\"],[\"N/A\",\"N/A\",\"12.73\",\"N/A\",\"9.03\",\"N/A\",\"N/A\",\"N/A\",\"10.04\",\"6.35\",\"N/A\",\"N/A\",\"N/A\",\"19.63\",\"3.15\",\"5.85\",\"N/A\",\"N/A\",\"-2.77\",\"3.68\",\"N/A\",\"N/A\",\"-2.09\",\"0.73\",\"1.52\",\"N/A\",\"N/A\",\"N/A\",\"-60.18\",\"N/A\",\"N/A\",\"16.26\",\"N/A\",\"17.92\",\"-37.91\",\"N/A\",\"9.06\",\"-15.36\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"-0.70\",\"1.56\",\"N/A\",\"9.22\",\"-6.82\",\"2.64\",\"0.81\",\"1.04\",\"N/A\",\"N/A\",\"N/A\",\"31.06\",\"N/A\",\"7.94\",\"N/A\",\"N/A\",\"-13.15\",\"1.77\",\"-13.90\",\"N/A\",\"-9.94\",\"N/A\",\"6.98\",\"N/A\",\"24.92\",\"N/A\",\"2.10\",\"-14.73\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"7.59\",\"N/A\",\"1.08\",\"-1.02\",\"5.62\",\"5.92\",\"N/A\",\"1.17\",\"N/A\",\"0.56\",\"N/A\",\"N/A\",\"N/A\",\"8.93\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"-37.21\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>N<\\/th>\\n      <th>종목명<\\/th>\\n      <th>현재가<\\/th>\\n      <th>전일비<\\/th>\\n      <th>등락률<\\/th>\\n      <th>거래량<\\/th>\\n      <th>거래대금<\\/th>\\n      <th>매수호가<\\/th>\\n      <th>매도호가<\\/th>\\n      <th>시가총액<\\/th>\\n      <th>PER<\\/th>\\n      <th>ROE<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":1},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"N\",\"targets\":1},{\"name\":\"종목명\",\"targets\":2},{\"name\":\"현재가\",\"targets\":3},{\"name\":\"전일비\",\"targets\":4},{\"name\":\"등락률\",\"targets\":5},{\"name\":\"거래량\",\"targets\":6},{\"name\":\"거래대금\",\"targets\":7},{\"name\":\"매수호가\",\"targets\":8},{\"name\":\"매도호가\",\"targets\":9},{\"name\":\"시가총액\",\"targets\":10},{\"name\":\"PER\",\"targets\":11},{\"name\":\"ROE\",\"targets\":12}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n:::\n\n## API의 활용\n\nKOSIS를 포함한 많은 대한민국의 데이터 포털은 개방 API 서비스를 제공하고 있다. KOSIS는 공유서비스 홈페이지([https://kosis.kr/openapi/](https://kosis.kr/openapi/index.jsp))를 통해 Open API를 통한 데이터 수집을 권장하고 있다.\n\n앞에서 설명한 것처럼, API용 패키지를 직접 사용할 수도 있지만, 래퍼 패키지가 존재하기만 한다면 그것을 활용하는 것이 훨씬 손쉬운 옵션일 수 있다. 놀랍게도 한국의 주석훈(Seokhoon Joo)이라는 분이 그러한 기능을 하는 `kosis`([https://cran.r-project.org/web/packages/kosis/index.html](https://cran.r-project.org/web/packages/kosis/))라는 패키지를 이미 개발해 두었고, 그것을 활용하고자 한다.\n\n실습 주제는 2022년 센서스 인구 기준으로 전국의 17개 시도별 '지방소멸위험지수'를 계산하고 그래프의 형태로 표현하는 것이다.\n\n### KOSIS에서 API KEY 받기\n\n먼저 API를 활용하기 위해 기관으로부터 KEY를 발급받아야 한다. 이를 위해 통계청에 회원가입을 한 후, KEY를 요청해야 한다. 과정은 아래와 같다.\n\n-   KOSIS 공유서비스 웹페이지(<https://kosis.kr/openapi/>) 접속\n\n-   상단의 \\[활용신청\\] 탭 클릭\n\n    -   통계청의 ONE-ID로 통합로그인(없으면 회원가입 필수)\n\n-   활용신청하여 사용자 인증키 획득\n\n    -   사용자 인증키는 마이페이지에서 언제든 확인 가능\n\n### 패키지 설치 및 인증키 등록\n\n우선 `kosis` 패키지를 오른쪽 하단 윈도우의 Packages 탭을 활용하여 인스톨한다. 이후에 아래와 같이 `kosis`와 `tidyverse` 패키지를 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(kosis)\n```\n:::\n\n\n다음으로, `kosis` 패키지의 [`kosis.setKey()`](https://rdrr.io/pkg/kosis/man/kosis.setKey.html) 함수를 이용하여 인증키를 등록한다. Your Key Here 자리에 부여받은 인증키를 붙여 넣는다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkosis.setKey(apiKey = \"Your Key Here\")\n```\n:::\n\n\n### 데이터 추출\n\n이제 통계청 홈페이지에 접속해서 데이터를 불러와본다. 과정은 아래와 같다.\n\n-   KOSIS에 접속 후 로그인\n\n-   데이터에 접근 후 URL 생성\n\n    -   \\[국내통계\\]-\\[주제별 통계\\]-\\[인구\\]-\\[인구총조사\\]-\\[인구부문\\]-\\[총조사인구(2015년 이후)\\]-\\[전수부문 (등록센서스, 2015년 이후)\\]-\\[전수기본표\\]-\\[연령 및 성별 인구\\]\n\n    -   **항목**: '총인구(명)', '총인구_남자(명)', '총인구_여자(명)'만 선택(더 많은 항목을 선택하면 데이터가 너무 커 에러가 발생)\n\n    -   **행정구역별(읍면동)**: '1 레벨'과 '2 레벨' 선택('1 레벨'은 시도 수준, '2 레벨'은 시군구 수준)\n\n    -   **조회기간**: '기간설정' 버턴을 누른 후, 기간설정이 2022\\~2022년인지 확인한다.\n\n    -   **응답필드**: 하나씩 눌러 모두 선택한 후, 'URL생성' 탭을 클릭한다. 그리고 나서 'URL 복사' 탭을 클릭한다. URL 속에 api key가 포함되어 있음을 확인한\n\n-   생성한 URL로부터 데이터 획득\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyour_url <- \"Your URL\"\ndata_api <- getStatDataFromURL(url = your_url)\n```\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\n`getStatDataFromURL` 함수의 아규먼트에 위에서 생성한 URL을 입력하면, 다운로드 과정 없이 곧바로 데이터를 획득할 수 있다.\n\n### 데이터 정리 및 변형\n\n아래와 같이 데이터를 정리 및 변형한다. 최종적으로 지역별 지역소멸위험지수를 산출한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data_api |> \n  select(C1, C1_NM, C2, C2_NM, ITM_ID, ITM_NM, DT) |> \n  mutate(\n    across(c(C1, DT), as.numeric),\n    ITM_ID = case_match(\n    ITM_ID, \"T00\" ~ \"T\",\n    \"T01\" ~ \"M\",\n    \"T02\" ~ \"F\"),\n  ) |>\n  unite(\"gender_age\", ITM_ID, C2_NM, sep = \"_\") |> \n  pivot_wider(\n    id_cols = c(C1, C1_NM),\n    names_from = gender_age,\n    values_from = DT\n  ) |> \n  mutate(\n    index = (`F_20~24세` + `F_25~29세` + `F_30~34세` + `F_35~39세`) / `T_65세이상`\n  ) |> \n  select(\n    C1, C1_NM, index\n  )\n```\n:::\n\n\n시도 데이터와 시군구 데이터를 분리하여 저장한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_sido <- data |> \n  filter(nchar(C1) == 2) \n\ndata_sgg <- data |> \n  filter(nchar(C1) == 5 & substr(C1, 5, 5) == 0 & !C1_NM %in% c(\"동부\", \"면부\", \"읍부\"))\n```\n:::\n\n\n### 그래프 작성\n\n인구소멸위험지수 연구에서 주로 사용되는 5개의 위험도 클래스의 구분법을 적용하고, 위험도 클래스별로 특정한 색상을 적용하고, 그래프의 범례에 5개의 클래스가 모두 나타나게 하려다보니 코드가 조금 복잡해졌다. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_sido <- data_sido |> \n  mutate(\n    index_class = case_when(\n      index < 0.2 ~ \"1\",\n      index >= 0.2 & index < 0.5 ~ \"2\",\n      index >= 0.5 & index < 1.0 ~ \"3\",\n      index >= 1.0 & index < 1.5 ~ \"4\",\n      index >= 1.5 ~ \"5\"\n    ),\n    index_class = factor(index_class, levels = as.character(1:5))\n  )\n\nclass_color <- c(\"1\" = \"#d7191c\", \"2\" = \"#fdae61\",\n                 \"3\" = \"#ffffbf\", \"4\" = \"#a6d96a\", \n                 \"5\" = \"#1a9641\")\ndata_sido |> \n  ggplot(aes(x = index, y = fct_reorder(C1_NM, index))) +\n  geom_col(aes(fill = index_class), show.legend = TRUE) +\n  geom_text(aes(label = format(round(index, digits = 3), \n                               nsmall = 3)), hjust = -0.1) +\n  scale_x_continuous(limits = c(0, 1.5)) +\n  scale_fill_manual(name = \"Classes\", \n                    labels = c(\"< 0.2\", \"0.2 ~ 0.5\", \"0.5 ~ 1.0\", \n                               \"1.0 ~ 1.5\", \">= 1.5\"), \n                    values = class_color, drop = FALSE) +\n  labs(title = \"인구소멸위험지수, 2022년\", \n       x = \"인구소멸위험지수\", \n       y = \"\")\n```\n\n::: {.cell-output-display}\n![](lab_07_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n::: {.callout-tip collapse=\"false\"}\n## KOSIS API의 추가 예제\n\n이렇게 KOSIS 홈페이지에서 URL을 직접 지정하지 않고도 데이터를 불러오는 방법이 있다. `getStatData` 함수로, 기관명과 데이터 코드를 아규먼트에 입력하면 해당 데이터를 불러올 수 있다. 가령 방금 실습에서 사용한 데이터는 통계청의 2015년 인구총조사 전수부문의 연령 및 성별인구에 해당한다. 이때 통계청의 기관 코드는 [**101**]{.underline}, 해당 데이터의 코드는 [**DT_1IN503**]{.underline}이다.\n\n아래의 코드는 여기에 몇 개의 아규먼트를 더 추가하여 서울특별시 종로구의 2015년부터 2022년까지의 데이터를 불러오고, 이를 바탕으로 인구소멸지수를 계산하여 그 추이를 시각화 한 것이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\naoi_code <- \"11010\" # 서울특별시 종로구 코드\naoi <- getStatData(orgId = 101, tblId = \"DT_1IN1503\", prdSe = \"Y\",\n                    startPrdDe = \"2015\", endPrdDe = \"2022\",\n                    objL1 = aoi_code, objL2 = \"ALL\") |> \n  filter(nchar(C2) == 3)\n\naoi <- aoi |> \n  select(C1, C1_NM, C2, C2_NM, ITM_ID, ITM_NM, DT, PRD_DE) |> \n  filter(ITM_ID == \"T00\" | ITM_ID == \"T01\" | ITM_ID == \"T02\") |> \n  mutate(\n    across(c(C1, DT), as.numeric),\n    ITM_ID = case_match(\n      ITM_ID, \"T00\" ~ \"T\",\n      \"T01\" ~ \"M\",\n      \"T02\" ~ \"F\"),\n  ) |> \n  unite(\"gender_age\", ITM_ID, C2_NM, sep = \"_\") |> \n  pivot_wider(\n    id_cols = c(C1, C1_NM, PRD_DE),\n    names_from = gender_age,\n    values_from = DT\n  ) |> \n  mutate(\n    index = (`F_20~24세` + `F_25~29세` + `F_30~34세` + `F_35~39세`) / `T_65세이상`\n  ) |> \n  select(\n    C1, C1_NM, index, PRD_DE\n  )\n\nregion <- aoi$C1_NM[1]\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naoi |> \n  ggplot(aes(x=PRD_DE, y=index)) +\n  geom_point() +\n  geom_line(group = 1, linewidth = 0.5) +\n  ggtitle(paste0(region, \" 인구소멸위험지수 추이\")) +\n  xlab(label = \"연도\") +\n  ylab(label = \"인구소멸위험지수\") +\n  theme(plot.title = element_text(size = 18, hjust=0.5))\n```\n\n::: {.cell-output-display}\n![](lab_07_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n`aoi_code`에 내가 원하는 지역의 코드를 넣으면 마찬가지로 해당 관심지역의 인구소멸위험지수 추이를 관측할 수 있다. 예컨대 인구가 빠르게 증가하는 경기 김포시는 \"31230\", 화성시는 \"31240\"이고, 소멸지수가 가장 높은 경북 상주시는 \"37080\", 경북 문경시는 \"37090\"이다. 제공한 코드에서 한번 `aoi_code` 부분만 변경해보자.\n\n한편, 이렇게 URL 없이 데이터를 불러오는 경우 KOSIS에서 직접 조정하는 것에 비해 덜 번거롭지만 제한사항도 많다. 가령 복수의 지역을 불러오는 것이 반복문을 사용하지 않고서는 불가능하고, 불필요한 데이터를 빼고 가져오기도 어렵다. 그러나 startPrdDe와 endPrdDe 아규먼트를 이용해 데이터를 시계열로 수집하고자 하는 측면에서는 유용하다.\n\n그러므로 수집하고자 하는 데이터를 잘 파악해서 API를 활용해보자.\n:::\n\n### cf) KOSIS API를 활용한 함수 작성\n\n마지막으로, API를 활용한 함수를 소개한다. API를 신청할 때 보았듯, 이는 웹/앱 애플리케이션을 제작하기 위한 용도로 주로 사용된다.\n\n이와 관련된 매우 간단한 예시로, 학생에게 인구소멸지수가 궁금한 지역을 검색해보도록 하는 활동을 구상한다고 가정해보자. 학생이 매번 코드를 작성하며 확인하기란 사실상 불가능하다. 그런데 위에서 사용한 코드와 API를 활용하면 함수를 어렵지 않게 생성할 수 있다.\n\n예컨대 교사가 아래와 같이 `exInd()` 함수를 한번 작성해두면, 학생은 단 한 줄의 코드만 입력해도 금방 지역의 인구소멸지수의 추이를 탐색해볼 수 있을 것이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 함수 생성: 교사 작성 부분\nexInd <- function(){\n  # Library\n  library(tidyverse)\n  library(kosis)\n  library(DT)\n  library(openxlsx)\n  \n  # Table for Searching Region Code\n  region_table <- read.xlsx(\"https://github.com/Sechang-Kim/gis-lab/raw/download/korea-sigungu-code(2022).xlsx\")\n  print(datatable(region_table))\n  \n  # Input Arguments\n  aoi_code <- readline('지역 코드를 입력하세요: ')\n  start <- as.numeric(readline('시작 연도를 입력하세요: '))\n  end <- as.numeric(readline('종료 연도를 입력하세요: '))\n  \n  # Data Request\n  aoi <- getStatData(orgId = 101, tblId = \"DT_1IN1503\", prdSe = \"Y\",\n                     startPrdDe = start, endPrdDe = end,\n                     objL1 = aoi_code, objL2 = \"ALL\") |> \n    filter(nchar(C2) == 3) # Delete 1-age interval(Only 5-age interval)\n  \n  # Data Cleansing\n  aoi <- aoi |> \n    select(C1, C1_NM, C2, C2_NM, ITM_ID, ITM_NM, DT, PRD_DE) |> \n    filter(ITM_ID == \"T00\" | ITM_ID == \"T01\" | ITM_ID == \"T02\") |> \n    mutate(\n      across(c(C1, DT), as.numeric),\n      ITM_ID = case_match(\n        ITM_ID, \"T00\" ~ \"T\",\n        \"T01\" ~ \"M\",\n        \"T02\" ~ \"F\"),\n    ) |> \n    unite(\"gender_age\", ITM_ID, C2_NM, sep = \"_\") |> \n    pivot_wider(\n      id_cols = c(C1, C1_NM, PRD_DE),\n      names_from = gender_age,\n      values_from = DT\n    ) |> \n    mutate(\n      index = (`F_20~24세` + `F_25~29세` + `F_30~34세` + `F_35~39세`) / `T_65세이상`\n    ) |> \n    select(\n      C1, C1_NM, index, PRD_DE\n    )\n  \n  ## Visualization\n  region <- aoi$C1_NM[1] # For Auto-Plot Title\n  vis <- aoi |> \n    ggplot(aes(x=PRD_DE, y=index)) +\n    geom_point() +\n    geom_line(group = 1, linewidth = 0.5) +\n    ggtitle(paste0(region, \" 인구소멸위험지수 추이\")) +\n    xlab(label = \"연도\") +\n    ylab(label = \"인구소멸위험지수\") +\n    theme(plot.title = element_text(size = 18, hjust=0.5))\n  \n  return(vis)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 함수 실행: 학생 작성 부분\nexInd()\n```\n:::\n\n",
    "supporting": [
      "lab_07_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}