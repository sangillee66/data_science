{
  "hash": "abe77f8a3eee0b3b5587e1aeca4fdb6e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"데이터 수집하기\"\nauthor: \"이상일, 김우형\"\ndate-modified: last-modified\nnumber-sections: true\nformat: \n  html: \n    toc: true\n    embed-resources: false\ncode-link: true\ncode-copy: true\nexecute: \n  warning: false\n  error: false\n  freeze: auto\neditor: visual\n---\n\n## 실습 개요 {.unnumbered}\n\n이 실습은 R로 데이터를 수집하는 과정을 다룬다. R을 활용한 데이터 수집은 다양한 방법으로 진행될 수 있지만 여기서는 웹상의 데이터 파일 불러오기, 웹 스크레이핑, API를 이용하는 방식에 집중한다. 실습의 시작은 [`tidyverse`](https://www.tidyverse.org/) 패키지를 불러오는 것이다.\n\n## 웹상의 데이터 파일 불러오기\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n\n아마도 데이터를 수집하는 가장 단순한 방법은 웹상에 파일 형태로 존재하는 데이터를 R에서 불러오는 것일 것이다. `readr` 패키지에서 제공하는 다양한 데이터 불러오기 함수(예: [`read_csv()`](https://readr.tidyverse.org/reference/read_delim.html))를 데이터의 URL에 적용하면 손쉽게 데이터를 획득할 수 있다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstudents <- read_csv(\"https://pos.it/r4ds-students-csv\")\nstudents\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 5\n  `Student ID` `Full Name`      favourite.food     mealPlan            AGE  \n         <dbl> <chr>            <chr>              <chr>               <chr>\n1            1 Sunil Huffmann   Strawberry yoghurt Lunch only          4    \n2            2 Barclay Lynn     French fries       Lunch only          5    \n3            3 Jayendra Lyne    N/A                Breakfast and lunch 7    \n4            4 Leon Rossini     Anchovies          Lunch only          <NA> \n5            5 Chidiegwu Dunkel Pizza              Breakfast and lunch five \n6            6 Güvenç Attila    Ice cream          Lunch only          6    \n```\n\n\n:::\n:::\n\n\n그런데 엑셀 형식의 파일은 [`readxl`](https://readxl.tidyverse.org/) 패키지가 제공하는 [`read_excel()`](https://readxl.tidyverse.org/reference/read_excel.html) 함수를 이용해 막바로 데이터를 불러오는 것이 불가능하다. [`openxlsx`](https://ycphs.github.io/openxlsx/) 패키지는 이러한 문제를 해결할 수 있게 해준다. 정말 다양한 함수를 제공하지만 [`read.xlsx()`](https://rdrr.io/pkg/openxlsx/man/read.xlsx.html) 함수가 URL을 통해 엑셀 데이터를 불러오는데 사용된다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\nxlsx_data <- read.xlsx(\"https://github.com/awalker89/openxlsx/raw/master/inst/readTest.xlsx\")\nxlsx_data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    Var1 Var2   Var3 Var4  Var5         Var6 Var7\n1   TRUE    1   1.00    a 42042 3209324 This   NA\n2   TRUE   NA     NA    b 42041         <NA>   NA\n3   TRUE    2   1.34    c 42040         <NA>   NA\n4  FALSE    2     NA <NA>    NA         <NA>   NA\n5  FALSE    3   1.56    e    NA         <NA>   NA\n6  FALSE    1   1.70    f 42037         <NA>   NA\n7     NA   NA     NA <NA> 42036         <NA>   NA\n8  FALSE    2  23.00    h 42035         <NA>   NA\n9  FALSE    3  67.30    i 42034         <NA>   NA\n10    NA    1 123.00 <NA> 42033         <NA>   NA\n```\n\n\n:::\n:::\n\n\n## 웹스크레이핑\n\n웹스크레이핑(web scraping)이란 웹페이지로부터 특정한 데이터를 추출하는 것을 의미한다. R에서 웹스크레이핑은 `rvest` 패키지가 담당하는데, `reaxl` 패키지와 마찬가지로 `tidyverse`의 핵심 패키지는 아니기 때문에 따로 불러와야 한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rvest)\n```\n:::\n\n\n### 웹스크레이핑의 실제 1: 테이블이 하나 있는 경우\n\n위키피디어의 한 항목(List of countries and dependencies by population)에는 표 하나가 포함되어 있다. 해당 표의 데이터를 수집한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://en.wikipedia.org/wiki/List_of_countries_and_dependencies_by_population\"\nmy_table <- url |> \n  read_html() |> \n  html_element(\"table\") |> \n  html_table()\nmy_table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 240 × 6\n   Location      Population    `% ofworld` Date     Source (official or …¹ Notes\n   <chr>         <chr>         <chr>       <chr>    <chr>                  <chr>\n 1 World         8,232,000,000 100%        13 Jun … UN projection[1][3]    \"\"   \n 2 India         1,417,492,000 17.3%       1 Jul 2… Official projection[4] \"[b]\"\n 3 China         1,408,280,000 17.2%       31 Dec … Official estimate[5]   \"[c]\"\n 4 United States 340,110,988   4.1%        1 Jul 2… Official estimate[6]   \"[d]\"\n 5 Indonesia     284,438,782   3.5%        30 Jun … National annual proje… \"\"   \n 6 Pakistan      241,499,431   2.9%        1 Mar 2… 2023 census result[8]  \"[e]\"\n 7 Nigeria       223,800,000   2.7%        1 Jul 2… Official projection[9] \"\"   \n 8 Brazil        213,421,037   2.6%        1 Jul 2… Official estimate[10]  \"\"   \n 9 Bangladesh    169,828,911   2.1%        14 Jun … 2022 census result[11] \"[f]\"\n10 Russia        146,028,325   1.8%        1 Jan 2… Official estimate[13]  \"[g]\"\n# ℹ 230 more rows\n# ℹ abbreviated name: ¹​`Source (official or fromthe United Nations)`\n```\n\n\n:::\n:::\n\n\n수집한 데이터를 가공해본다. 필요없는 컬럼을 제거하고, 컬럼 이름을 바꾸고, 몇몇 변수를 특정 형태의 타입(numeric, date)으로 변환하기 위한 과정이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_table <- my_table |> \n  select(-6) |> \n  rename(\n    location = \"Location\",\n    population = \"Population\",\n    pop_pct = \"% ofworld\",\n    date = \"Date\",\n    source = \"Source (official or fromthe United Nations)\"\n  ) |> \n  mutate(\n    population = str_remove_all(population, \",\"),\n    population = as.numeric(population),\n    pop_pct = str_remove(pop_pct, \"%\"),\n    pop_pct = as.numeric(pop_pct),\n    date = dmy(date)\n  )\n\nmy_table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 240 × 5\n   location      population pop_pct date       source                       \n   <chr>              <dbl>   <dbl> <date>     <chr>                        \n 1 World         8232000000   100   2025-06-13 UN projection[1][3]          \n 2 India         1417492000    17.3 2025-07-01 Official projection[4]       \n 3 China         1408280000    17.2 2024-12-31 Official estimate[5]         \n 4 United States  340110988     4.1 2024-07-01 Official estimate[6]         \n 5 Indonesia      284438782     3.5 2025-06-30 National annual projection[7]\n 6 Pakistan       241499431     2.9 2023-03-01 2023 census result[8]        \n 7 Nigeria        223800000     2.7 2023-07-01 Official projection[9]       \n 8 Brazil         213421037     2.6 2025-07-01 Official estimate[10]        \n 9 Bangladesh     169828911     2.1 2022-06-14 2022 census result[11]       \n10 Russia         146028325     1.8 2025-01-01 Official estimate[13]        \n# ℹ 230 more rows\n```\n\n\n:::\n:::\n\n\n::: {.callout-note title=\"유용한 문자열 함수\" collapse=\"true\"}\n코드에 포함된 `parse_number()`과 `str_remove_all()` 함수는 매우 유용한 함수이므로 잘 익혀 둘 필요가 있다. `parse_number()`함수는 [**readr**](https://readr.tidyverse.org/) 패키지에 포함되어 있는 것으로, 투입 벡터에서 오로지 숫자만 골라내 실수형 벡터를 생성해준다. 위의 예를 보자면, `my_table` 데이터 프레임의 `population` 컬럼은 인구수와 콤마가 결합된 문자형 벡터이므로 콤마를 제거하고 숫자만 추출할 필요가 있다. 유사한 함수에 `parse_logical()`, `parse_integer()`, `parse_double()`, `parse_character()`, `parse_factor()` 등이 있다. `str_remove_all()` 함수는 [**tidyverse**](https://www.tidyverse.org/)의 핵심 패키지 중의 하나인 [**stringr**](https://stringr.tidyverse.org/) 패키지에 포함되어 있는 것으로, 투입 벡터에서 특정한 문자나 문자 패턴을 제거해 준다. 위의 예를 보자면, `my_table` 데이터 프레임의 `pop_pct` 컬럼에는 %라는 부호가 포함되어 있기 때문에 그것을 제거할 필요가 있다. 그러므로 `str_remove_all()` 함수는 셀에 포함되어 있는 특정 문자 모두를 제거할 때 사용할 수 있는 함수이다. 유사한 함수에 `str_remove()`도 있는데, 이것은 셀에 포함되어 있는 특정 문자 중 단지 첫 번째 것만 제거한다. 문자열을 잘 다루려면 정규표현식(regular expression)에 대한 상당한 이해가 있어야 한다. 다음의 링크가 도움이 될 수 있을 것이다. <https://bookdown.org/ahn_media/bookdown-demo/cleantool.html#%EC%A0%95%EA%B7%9C%ED%91%9C%ED%98%84%EC%8B%9Dregular-expressions>\n:::\n\n### 웹스크레이핑의 실제 2: 테이블이 둘 이상인 경우\n\n위키피디아의 한 항목(List of FIPS country codes)에는 동일한 내용에 대해 여러 개의 표가 나타나 있다. 개별 표의 데이터를 수집한 후 결합하여 단일한 데이터 프레임을 구성한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://en.wikipedia.org/wiki/List_of_FIPS_country_codes\"\nmy_tables <- url |> \n  read_html() |> \n  html_elements(\"table\") |> # 'element'가 아니라 'elements'이다.\n  html_table() |> \n  bind_rows()\nmy_tables\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 277 × 10\n   Code    `Short-form name` .mw-parser-output .n…¹ .mw-parser-output .n…² ...3 \n   <chr>   <chr>             <chr>                  <chr>                  <chr>\n 1 .mw-pa… Aruba             <NA>                   <NA>                   <NA> \n 2 AC      Antigua and Barb… <NA>                   <NA>                   <NA> \n 3 AD      Akrotiri          <NA>                   <NA>                   <NA> \n 4 AE      United Arab Emir… <NA>                   <NA>                   <NA> \n 5 AF      Afghanistan       <NA>                   <NA>                   <NA> \n 6 AG      Algeria           <NA>                   <NA>                   <NA> \n 7 AJ      Azerbaijan        <NA>                   <NA>                   <NA> \n 8 AL      Albania           <NA>                   <NA>                   <NA> \n 9 AM      Armenia           <NA>                   <NA>                   <NA> \n10 AN      Andorra           <NA>                   <NA>                   <NA> \n# ℹ 267 more rows\n# ℹ abbreviated names:\n#   ¹​`.mw-parser-output .navbar{display:inline;font-size:88%;font-weight:normal}.mw-parser-output .navbar-collapse{float:left;text-align:left}.mw-parser-output .navbar-boxtext{word-spacing:0}.mw-parser-output .navbar ul{display:inline-block;white-space:nowrap;line-height:inherit}.mw-parser-output .navbar-brackets::before{margin-right:-0.125em;content:\"[ \"}.mw-parser-output .navbar-brackets::after{margin-left:-0.125em;content:\" ]\"}.mw-parser-output .navbar li{word-spacing:-0.125em}.mw-parser-output .navbar a>span,.mw-parser-output .navbar a>abbr{text-decoration:inherit}.mw-parser-output .navbar-mini abbr{font-variant:small-caps;border-bottom:none;text-decoration:none;cursor:inherit}.mw-parser-output .navbar-ct-full{font-size:114%;margin:0 7em}.mw-parser-output .navbar-ct-mini{font-size:114%;margin:0 4em}html.skin-theme-clientpref-night .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}@media(prefers-color-scheme:dark){html.skin-theme-clientpref-os .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}}@media print{.mw-parser-output .navbar{display:none!important}}vteGeocode systems...1`,\n#   ²​`.mw-parser-output .navbar{display:inline;font-size:88%;font-weight:normal}.mw-parser-output .navbar-collapse{float:left;text-align:left}.mw-parser-output .navbar-boxtext{word-spacing:0}.mw-parser-output .navbar ul{display:inline-block;white-space:nowrap;line-height:inherit}.mw-parser-output .navbar-brackets::before{margin-right:-0.125em;content:\"[ \"}.mw-parser-output .navbar-brackets::after{margin-left:-0.125em;content:\" ]\"}.mw-parser-output .navbar li{word-spacing:-0.125em}.mw-parser-output .navbar a>span,.mw-parser-output .navbar a>abbr{text-decoration:inherit}.mw-parser-output .navbar-mini abbr{font-variant:small-caps;border-bottom:none;text-decoration:none;cursor:inherit}.mw-parser-output .navbar-ct-full{font-size:114%;margin:0 7em}.mw-parser-output .navbar-ct-mini{font-size:114%;margin:0 4em}html.skin-theme-clientpref-night .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}@media(prefers-color-scheme:dark){html.skin-theme-clientpref-os .mw-parser-output .navbar li a abbr{color:var(--color-base)!important}}@media print{.mw-parser-output .navbar{display:none!important}}vteGeocode systems...2`\n# ℹ 5 more variables: ...4 <chr>, ...5 <chr>, ...6 <chr>, X1 <chr>, X2 <chr>\n```\n\n\n:::\n:::\n\n\n수집한 데이터를 약간 가공한다. 역시 필요한 컬럼만 남기고, 이름을 바꿔준다. 마지막 `str_extract`는 Aruba의 단축어에 원치 않는 문자열이 추가되어 있어 제거하기 위한 코드이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_tables <- my_tables |> \n  select(1, 2) |> \n  rename(\n    code = \"Code\", \n    short_name = \"Short-form name\"\n  ) |> \n  mutate(\n    code = str_extract(code, \"[A-Z][A-Z]\") # 알파벳 두 개가 연결되어 있는 것을 추출\n  )\nmy_tables\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 277 × 2\n   code  short_name          \n   <chr> <chr>               \n 1 AA    Aruba               \n 2 AC    Antigua and Barbuda \n 3 AD    Akrotiri            \n 4 AE    United Arab Emirates\n 5 AF    Afghanistan         \n 6 AG    Algeria             \n 7 AJ    Azerbaijan          \n 8 AL    Albania             \n 9 AM    Armenia             \n10 AN    Andorra             \n# ℹ 267 more rows\n```\n\n\n:::\n:::\n\n\n::: {.callout-tip collapse=\"false\"}\n## 추가 예제\n\n간혹 테이블을 불러올 때 데이터가 깨지는 경우도 발생한다. 이는 인코딩 방식의 문제인데, 아래와 같이 인코딩 아규먼트를 추가하면 해결된다. 보통 \"EUC-KR\"이나 \"UTF-8\" 둘 중 하나는 제대로 작동한다.\n\n한 번 네이버가 제공하는 주식 거래 상위 품목을 크롤링해보자.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(DT)\nkospi <- \"https://finance.naver.com/sise/sise_quant.naver?sosok=0\"\n\nkospi_table <- kospi |> \n  read_html(, encoding = \"EUC-KR\") |> \n  html_elements(\"table\") |> \n  html_table() |> \n  _[[2]] |> \n  filter(is.na(N) == FALSE)\n\ndatatable(kospi_table)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-f506e57621df1859adf8\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f506e57621df1859adf8\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\",\"26\",\"27\",\"28\",\"29\",\"30\",\"31\",\"32\",\"33\",\"34\",\"35\",\"36\",\"37\",\"38\",\"39\",\"40\",\"41\",\"42\",\"43\",\"44\",\"45\",\"46\",\"47\",\"48\",\"49\",\"50\",\"51\",\"52\",\"53\",\"54\",\"55\",\"56\",\"57\",\"58\",\"59\",\"60\",\"61\",\"62\",\"63\",\"64\",\"65\",\"66\",\"67\",\"68\",\"69\",\"70\",\"71\",\"72\",\"73\",\"74\",\"75\",\"76\",\"77\",\"78\",\"79\",\"80\",\"81\",\"82\",\"83\",\"84\",\"85\",\"86\",\"87\",\"88\",\"89\",\"90\",\"91\",\"92\",\"93\",\"94\",\"95\",\"96\",\"97\",\"98\",\"99\",\"100\"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100],[\"KODEX 200선물인버스2X\",\"KODEX 인버스\",\"KODEX 2차전지산업레버리지\",\"KODEX 레버리지\",\"삼성전자\",\"KODEX 코스닥150레버리지\",\"TIGER 200선물인버스2X\",\"KODEX 코스닥150선물인버스\",\"코오롱모빌리티그룹\",\"상상인증권\",\"KODEX 200\",\"TIGER 화장품\",\"동양\",\"KODEX 코스닥150\",\"카카오\",\"미래에셋증권\",\"삼성 인버스 2X 코스닥150 선물 ETN\",\"삼성 인버스 2X 코스피200 선물 ETN\",\"한국전력\",\"대한전선\",\"TIGER 반도체TOP10\",\"삼영\",\"TIGER 미국S&amp;P500\",\"TIGER 2차전지소재Fn\",\"금호타이어\",\"TIGER 2차전지TOP10레버리지\",\"SK하이닉스\",\"두산에너빌리티\",\"대원전선\",\"PLUS 고배당주\",\"ACE KRX금현물\",\"KODEX 200타겟위클리커버드콜\",\"SK증권\",\"삼성중공업\",\"KODEX AI전력핵심설비\",\"대덕전자\",\"TIGER 코리아AI전력기기TOP3플러스\",\"KODEX 은행\",\"형지엘리트\",\"KODEX 미국S&amp;P500\",\"HJ중공업\",\"KODEX AI반도체\",\"KODEX 2차전지산업\",\"우리금융지주\",\"KODEX 금융고배당TOP10타겟위클리커버드콜\",\"TIGER 200\",\"삼성 인버스 2X WTI원유 선물 ETN\",\"KODEX 반도체레버리지\",\"KODEX 증권\",\"ACE 테슬라밸류체인액티브\",\"DB하이텍\",\"한온시스템\",\"TIGER 은행고배당플러스TOP10\",\"에이프로젠\",\"TIGER TOP10\",\"서울식품\",\"TIGER 차이나휴머노이드로봇\",\"SOL 금융지주플러스고배당\",\"TIGER 리츠부동산인프라\",\"유진투자증권\",\"한화투자증권\",\"TIGER 2차전지TOP10\",\"디아이씨\",\"TIGER 지주회사\",\"삼성전자우\",\"TIGER 미국30년국채커버드콜액티브(H)\",\"SOL 조선TOP3플러스\",\"YG PLUS\",\"신한 인버스 2X WTI원유 선물 ETN(H)\",\"ACE 미국30년국채액티브(H)\",\"TIGER 차이나전기차SOLACTIVE\",\"미래에셋 인버스 2X 코스피200 선물 ETN\",\"TIGER 미국테크TOP10 INDXX\",\"일동제약\",\"대한해운\",\"신한지주\",\"이수페타시스\",\"KODEX 반도체\",\"NH투자증권\",\"KODEX 미국나스닥100\",\"TIGER KRX금현물\",\"KODEX 미국AI전력핵심인프라\",\"HANARO Fn K-반도체\",\"삼성제약\",\"파미셀\",\"KODEX 2차전지핵심소재10\",\"TIMEFOLIO K바이오액티브\",\"TIGER 미국AI전력SMR\",\"한화오션\",\"후성\",\"TIGER 조선TOP10\",\"DYP\",\"한국타이어앤테크놀로지\",\"KB금융\",\"TIGER 200 중공업\",\"TIGER 차이나항셍테크\",\"KODEX 미국30년국채타겟커버드콜(합성 H)\",\"ACE AI반도체포커스\",\"TIGER 코리아배당다우존스\",\"삼성 레버리지 천연가스 선물 ETN C\"],[\"706\",\"2,590\",\"1,779\",\"43,600\",\"100,600\",\"11,410\",\"748\",\"2,985\",\"13,130\",\"724\",\"57,655\",\"3,510\",\"877\",\"15,320\",\"62,300\",\"23,900\",\"3,695\",\"4,015\",\"46,250\",\"24,950\",\"18,825\",\"5,650\",\"24,410\",\"5,620\",\"5,400\",\"1,656\",\"606,000\",\"79,600\",\"4,040\",\"21,070\",\"27,500\",\"13,620\",\"698\",\"27,050\",\"25,775\",\"47,300\",\"13,620\",\"12,725\",\"1,354\",\"22,355\",\"22,000\",\"17,040\",\"15,935\",\"26,200\",\"12,750\",\"57,675\",\"86\",\"27,865\",\"15,845\",\"21,940\",\"61,800\",\"4,405\",\"21,260\",\"640\",\"19,590\",\"150\",\"12,770\",\"17,495\",\"4,380\",\"3,790\",\"5,320\",\"10,020\",\"6,050\",\"16,725\",\"77,100\",\"7,885\",\"35,915\",\"6,320\",\"70\",\"7,820\",\"13,150\",\"4,015\",\"31,000\",\"27,050\",\"1,850\",\"78,800\",\"117,100\",\"58,820\",\"21,950\",\"24,485\",\"13,130\",\"19,050\",\"19,320\",\"1,467\",\"18,040\",\"5,685\",\"16,480\",\"9,465\",\"129,600\",\"8,810\",\"28,120\",\"3,060\",\"58,500\",\"129,000\",\"14,640\",\"9,490\",\"8,535\",\"25,600\",\"13,275\",\"3,495\"],[\"하락\\n\\t\\t\\t\\t46\",\"하락\\n\\t\\t\\t\\t80\",\"상승\\n\\t\\t\\t\\t90\",\"상승\\n\\t\\t\\t\\t2,540\",\"상승\\n\\t\\t\\t\\t2,700\",\"상승\\n\\t\\t\\t\\t185\",\"하락\\n\\t\\t\\t\\t49\",\"하락\\n\\t\\t\\t\\t25\",\"상한가\\n\\t\\t\\t\\t3,030\",\"상승\\n\\t\\t\\t\\t61\",\"상승\\n\\t\\t\\t\\t1,710\",\"하락\\n\\t\\t\\t\\t20\",\"상승\\n\\t\\t\\t\\t28\",\"상승\\n\\t\\t\\t\\t135\",\"하락\\n\\t\\t\\t\\t500\",\"상승\\n\\t\\t\\t\\t800\",\"하락\\n\\t\\t\\t\\t55\",\"하락\\n\\t\\t\\t\\t275\",\"상승\\n\\t\\t\\t\\t2,150\",\"상승\\n\\t\\t\\t\\t200\",\"상승\\n\\t\\t\\t\\t775\",\"상승\\n\\t\\t\\t\\t1,020\",\"상승\\n\\t\\t\\t\\t55\",\"상승\\n\\t\\t\\t\\t140\",\"상승\\n\\t\\t\\t\\t390\",\"상승\\n\\t\\t\\t\\t87\",\"상승\\n\\t\\t\\t\\t26,000\",\"상승\\n\\t\\t\\t\\t1,700\",\"상승\\n\\t\\t\\t\\t55\",\"상승\\n\\t\\t\\t\\t810\",\"상승\\n\\t\\t\\t\\t135\",\"상승\\n\\t\\t\\t\\t420\",\"상승\\n\\t\\t\\t\\t49\",\"상승\\n\\t\\t\\t\\t750\",\"상승\\n\\t\\t\\t\\t1,110\",\"상승\\n\\t\\t\\t\\t5,050\",\"상승\\n\\t\\t\\t\\t580\",\"상승\\n\\t\\t\\t\\t385\",\"상승\\n\\t\\t\\t\\t149\",\"상승\\n\\t\\t\\t\\t45\",\"하락\\n\\t\\t\\t\\t450\",\"상승\\n\\t\\t\\t\\t740\",\"상승\\n\\t\\t\\t\\t395\",\"상승\\n\\t\\t\\t\\t500\",\"상승\\n\\t\\t\\t\\t460\",\"상승\\n\\t\\t\\t\\t1,725\",\"하락\\n\\t\\t\\t\\t2\",\"상승\\n\\t\\t\\t\\t1,195\",\"상승\\n\\t\\t\\t\\t960\",\"하락\\n\\t\\t\\t\\t455\",\"상승\\n\\t\\t\\t\\t8,400\",\"상승\\n\\t\\t\\t\\t130\",\"상승\\n\\t\\t\\t\\t650\",\"상승\\n\\t\\t\\t\\t20\",\"상승\\n\\t\\t\\t\\t555\",\"보합0\",\"하락\\n\\t\\t\\t\\t330\",\"상승\\n\\t\\t\\t\\t660\",\"상승\\n\\t\\t\\t\\t20\",\"상승\\n\\t\\t\\t\\t300\",\"상승\\n\\t\\t\\t\\t300\",\"상승\\n\\t\\t\\t\\t235\",\"하락\\n\\t\\t\\t\\t440\",\"상승\\n\\t\\t\\t\\t845\",\"상승\\n\\t\\t\\t\\t1,800\",\"하락\\n\\t\\t\\t\\t45\",\"상승\\n\\t\\t\\t\\t905\",\"하락\\n\\t\\t\\t\\t220\",\"하락\\n\\t\\t\\t\\t1\",\"하락\\n\\t\\t\\t\\t55\",\"하락\\n\\t\\t\\t\\t135\",\"하락\\n\\t\\t\\t\\t255\",\"상승\\n\\t\\t\\t\\t150\",\"하락\\n\\t\\t\\t\\t1,050\",\"상승\\n\\t\\t\\t\\t65\",\"상승\\n\\t\\t\\t\\t1,400\",\"상승\\n\\t\\t\\t\\t13,100\",\"상승\\n\\t\\t\\t\\t1,470\",\"상승\\n\\t\\t\\t\\t2,020\",\"상승\\n\\t\\t\\t\\t55\",\"상승\\n\\t\\t\\t\\t80\",\"상승\\n\\t\\t\\t\\t645\",\"상승\\n\\t\\t\\t\\t630\",\"하락\\n\\t\\t\\t\\t83\",\"상승\\n\\t\\t\\t\\t740\",\"상승\\n\\t\\t\\t\\t110\",\"상승\\n\\t\\t\\t\\t10\",\"상승\\n\\t\\t\\t\\t380\",\"상승\\n\\t\\t\\t\\t2,800\",\"하락\\n\\t\\t\\t\\t210\",\"상승\\n\\t\\t\\t\\t700\",\"하락\\n\\t\\t\\t\\t110\",\"상승\\n\\t\\t\\t\\t9,150\",\"상승\\n\\t\\t\\t\\t5,300\",\"상승\\n\\t\\t\\t\\t470\",\"상승\\n\\t\\t\\t\\t55\",\"하락\\n\\t\\t\\t\\t60\",\"상승\\n\\t\\t\\t\\t880\",\"상승\\n\\t\\t\\t\\t665\",\"상승\\n\\t\\t\\t\\t130\"],[\"-6.12%\",\"-3.00%\",\"+5.33%\",\"+6.19%\",\"+2.76%\",\"+1.65%\",\"-6.15%\",\"-0.83%\",\"+30.00%\",\"+9.20%\",\"+3.06%\",\"-0.57%\",\"+3.30%\",\"+0.89%\",\"-0.80%\",\"+3.46%\",\"-1.47%\",\"-6.41%\",\"+4.88%\",\"+0.81%\",\"+4.29%\",\"+22.03%\",\"+0.23%\",\"+2.55%\",\"+7.78%\",\"+5.54%\",\"+4.48%\",\"+2.18%\",\"+1.38%\",\"+4.00%\",\"+0.49%\",\"+3.18%\",\"+7.55%\",\"+2.85%\",\"+4.50%\",\"+11.95%\",\"+4.45%\",\"+3.12%\",\"+12.37%\",\"+0.20%\",\"-2.00%\",\"+4.54%\",\"+2.54%\",\"+1.95%\",\"+3.74%\",\"+3.08%\",\"-2.27%\",\"+4.48%\",\"+6.45%\",\"-2.03%\",\"+15.73%\",\"+3.04%\",\"+3.15%\",\"+3.23%\",\"+2.92%\",\"0.00%\",\"-2.52%\",\"+3.92%\",\"+0.46%\",\"+8.60%\",\"+5.98%\",\"+2.40%\",\"-6.78%\",\"+5.32%\",\"+2.39%\",\"-0.57%\",\"+2.58%\",\"-3.36%\",\"-1.41%\",\"-0.70%\",\"-1.02%\",\"-5.97%\",\"+0.49%\",\"-3.74%\",\"+3.64%\",\"+1.81%\",\"+12.60%\",\"+2.56%\",\"+10.14%\",\"+0.23%\",\"+0.61%\",\"+3.50%\",\"+3.37%\",\"-5.35%\",\"+4.28%\",\"+1.97%\",\"+0.06%\",\"+4.18%\",\"+2.21%\",\"-2.33%\",\"+2.55%\",\"-3.47%\",\"+18.54%\",\"+4.28%\",\"+3.32%\",\"+0.58%\",\"-0.70%\",\"+3.56%\",\"+5.27%\",\"+3.86%\"],[\"1,219,670,272\",\"81,646,319\",\"39,148,463\",\"25,466,939\",\"23,415,247\",\"21,632,700\",\"16,711,648\",\"16,117,669\",\"11,729,586\",\"9,483,104\",\"9,446,204\",\"8,832,425\",\"8,727,722\",\"8,380,419\",\"7,961,192\",\"6,747,189\",\"6,713,376\",\"6,484,708\",\"6,243,476\",\"5,903,918\",\"5,604,801\",\"5,350,245\",\"5,125,226\",\"5,055,441\",\"5,034,112\",\"4,888,096\",\"4,868,645\",\"4,562,734\",\"4,554,870\",\"4,545,593\",\"4,525,375\",\"4,487,791\",\"4,203,471\",\"4,105,719\",\"4,072,378\",\"4,054,350\",\"3,991,253\",\"3,965,168\",\"3,952,154\",\"3,606,149\",\"3,585,053\",\"3,553,402\",\"3,375,551\",\"3,344,013\",\"3,317,152\",\"3,301,336\",\"3,292,687\",\"3,281,820\",\"3,279,252\",\"3,199,770\",\"3,144,244\",\"3,007,163\",\"2,814,198\",\"2,774,538\",\"2,618,592\",\"2,599,741\",\"2,560,352\",\"2,531,882\",\"2,512,365\",\"2,493,203\",\"2,448,599\",\"2,444,053\",\"2,411,662\",\"2,370,126\",\"2,354,186\",\"2,344,045\",\"2,331,974\",\"2,298,821\",\"2,272,925\",\"2,252,462\",\"2,231,964\",\"2,231,051\",\"2,210,164\",\"2,208,938\",\"2,194,235\",\"2,192,476\",\"2,190,233\",\"2,164,557\",\"2,104,817\",\"2,078,620\",\"2,059,176\",\"2,033,769\",\"2,020,005\",\"1,974,639\",\"1,944,011\",\"1,906,432\",\"1,906,158\",\"1,850,249\",\"1,847,178\",\"1,847,083\",\"1,824,355\",\"1,805,497\",\"1,785,297\",\"1,775,327\",\"1,729,007\",\"1,715,869\",\"1,687,412\",\"1,674,921\",\"1,649,317\",\"1,641,656\"],[\"872,197\",\"212,804\",\"67,616\",\"1,095,912\",\"2,335,834\",\"243,594\",\"12,695\",\"48,491\",\"139,928\",\"7,105\",\"541,752\",\"30,586\",\"7,684\",\"127,633\",\"508,576\",\"162,526\",\"25,068\",\"26,757\",\"285,839\",\"144,978\",\"104,094\",\"29,357\",\"125,119\",\"27,759\",\"26,449\",\"7,891\",\"2,936,514\",\"360,358\",\"18,282\",\"95,250\",\"124,743\",\"60,643\",\"2,868\",\"110,678\",\"103,041\",\"185,327\",\"53,372\",\"50,791\",\"5,232\",\"80,626\",\"77,363\",\"59,963\",\"52,935\",\"88,301\",\"42,409\",\"189,473\",\"286\",\"89,184\",\"51,202\",\"70,267\",\"192,445\",\"13,256\",\"60,250\",\"1,779\",\"51,320\",\"389\",\"33,007\",\"44,479\",\"10,992\",\"9,256\",\"12,822\",\"24,255\",\"14,923\",\"39,343\",\"180,239\",\"18,481\",\"83,170\",\"14,864\",\"158\",\"17,632\",\"29,623\",\"9,188\",\"68,401\",\"60,096\",\"4,038\",\"175,539\",\"248,175\",\"125,239\",\"45,078\",\"50,826\",\"27,066\",\"38,433\",\"38,575\",\"2,840\",\"34,705\",\"10,613\",\"31,528\",\"17,329\",\"237,302\",\"16,269\",\"50,948\",\"6,490\",\"102,238\",\"231,077\",\"25,122\",\"16,185\",\"14,419\",\"42,555\",\"21,726\",\"5,657\"],[\"706\",\"2,585\",\"1,778\",\"43,595\",\"100,500\",\"11,410\",\"747\",\"2,985\",\"13,130\",\"723\",\"57,655\",\"3,510\",\"877\",\"15,315\",\"62,200\",\"23,900\",\"3,690\",\"4,015\",\"46,250\",\"24,900\",\"18,820\",\"5,640\",\"24,410\",\"5,615\",\"5,380\",\"1,655\",\"606,000\",\"79,600\",\"4,035\",\"21,070\",\"27,495\",\"13,615\",\"697\",\"27,000\",\"25,770\",\"47,250\",\"13,615\",\"12,720\",\"1,351\",\"22,350\",\"22,000\",\"17,030\",\"15,930\",\"26,200\",\"12,750\",\"57,670\",\"86\",\"27,860\",\"15,845\",\"21,935\",\"61,800\",\"4,405\",\"21,260\",\"640\",\"19,590\",\"149\",\"12,770\",\"17,490\",\"4,375\",\"3,785\",\"5,310\",\"10,020\",\"6,050\",\"16,720\",\"77,000\",\"7,880\",\"35,910\",\"6,320\",\"69\",\"7,815\",\"13,150\",\"4,015\",\"30,995\",\"27,050\",\"1,850\",\"78,800\",\"117,000\",\"58,815\",\"21,900\",\"24,480\",\"13,125\",\"19,045\",\"19,315\",\"1,467\",\"18,040\",\"5,685\",\"16,475\",\"9,465\",\"129,600\",\"8,810\",\"28,120\",\"3,060\",\"58,400\",\"129,000\",\"14,615\",\"9,490\",\"8,535\",\"25,575\",\"13,270\",\"3,495\"],[\"707\",\"2,590\",\"1,779\",\"43,600\",\"100,600\",\"11,415\",\"748\",\"2,990\",\"0\",\"724\",\"57,660\",\"3,515\",\"878\",\"15,320\",\"62,300\",\"23,950\",\"3,695\",\"4,020\",\"46,300\",\"24,950\",\"18,825\",\"5,650\",\"24,415\",\"5,620\",\"5,400\",\"1,656\",\"607,000\",\"79,700\",\"4,040\",\"21,075\",\"27,500\",\"13,620\",\"698\",\"27,050\",\"25,775\",\"47,300\",\"13,620\",\"12,725\",\"1,354\",\"22,355\",\"22,050\",\"17,040\",\"15,935\",\"26,250\",\"12,755\",\"57,675\",\"87\",\"27,865\",\"15,850\",\"21,940\",\"61,900\",\"4,410\",\"21,265\",\"644\",\"19,605\",\"150\",\"12,775\",\"17,495\",\"4,380\",\"3,790\",\"5,320\",\"10,025\",\"6,060\",\"16,725\",\"77,100\",\"7,885\",\"35,915\",\"6,330\",\"70\",\"7,820\",\"13,155\",\"4,020\",\"31,000\",\"27,100\",\"1,851\",\"79,000\",\"117,100\",\"58,820\",\"21,950\",\"24,485\",\"13,130\",\"19,050\",\"19,320\",\"1,468\",\"18,050\",\"5,690\",\"16,480\",\"9,470\",\"129,700\",\"8,820\",\"28,125\",\"3,065\",\"58,500\",\"129,100\",\"14,640\",\"9,495\",\"8,545\",\"25,600\",\"13,275\",\"3,500\"],[\"15,579\",\"7,827\",\"5,442\",\"37,605\",\"5,955,156\",\"16,487\",\"613\",\"2,552\",\"8,243\",\"784\",\"106,287\",\"3,692\",\"2,093\",\"12,425\",\"275,564\",\"136,306\",\"1,478\",\"321\",\"296,908\",\"46,519\",\"17,893\",\"1,921\",\"110,699\",\"7,174\",\"15,512\",\"1,461\",\"4,411,694\",\"509,887\",\"3,029\",\"17,667\",\"28,655\",\"14,083\",\"3,299\",\"238,040\",\"9,537\",\"23,374\",\"2,901\",\"3,391\",\"520\",\"62,862\",\"19,865\",\"6,646\",\"16,031\",\"192,328\",\"5,355\",\"42,535\",\"1,287\",\"3,400\",\"4,793\",\"12,308\",\"26,886\",\"29,899\",\"7,398\",\"2,091\",\"13,987\",\"585\",\"4,278\",\"2,747\",\"9,143\",\"3,671\",\"11,414\",\"5,411\",\"2,353\",\"2,877\",\"629,116\",\"13,196\",\"19,394\",\"4,024\",\"443\",\"22,342\",\"18,031\",\"402\",\"40,455\",\"8,558\",\"5,971\",\"382,570\",\"85,962\",\"14,970\",\"78,218\",\"40,290\",\"7,990\",\"14,135\",\"7,747\",\"1,381\",\"10,827\",\"1,993\",\"2,686\",\"748\",\"397,112\",\"9,449\",\"7,775\",\"403\",\"72,467\",\"492,086\",\"4,386\",\"11,844\",\"8,825\",\"1,549\",\"5,556\",\"1,748\"],[\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"22.47\",\"N/A\",\"N/A\",\"N/A\",\"-198.94\",\"-2.38\",\"N/A\",\"N/A\",\"-2.51\",\"N/A\",\"129.52\",\"14.41\",\"N/A\",\"N/A\",\"4.69\",\"159.94\",\"N/A\",\"27.16\",\"N/A\",\"N/A\",\"5.97\",\"N/A\",\"15.29\",\"-476.65\",\"22.57\",\"N/A\",\"N/A\",\"N/A\",\"-24.07\",\"84.01\",\"N/A\",\"293.79\",\"N/A\",\"N/A\",\"-37.61\",\"N/A\",\"58.36\",\"N/A\",\"N/A\",\"6.75\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"12.11\",\"-7.10\",\"N/A\",\"-3.46\",\"N/A\",\"-18.75\",\"N/A\",\"N/A\",\"N/A\",\"6.94\",\"24.29\",\"N/A\",\"21.92\",\"N/A\",\"17.22\",\"N/A\",\"N/A\",\"37.40\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"-307.39\",\"3.92\",\"8.38\",\"76.14\",\"N/A\",\"10.42\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"1.36\",\"52.29\",\"N/A\",\"N/A\",\"N/A\",\"45.71\",\"-9.79\",\"N/A\",\"-39.74\",\"7.68\",\"8.84\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\"],[\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"9.03\",\"N/A\",\"N/A\",\"N/A\",\"-5.62\",\"-22.81\",\"N/A\",\"N/A\",\"-9.94\",\"N/A\",\"0.56\",\"7.94\",\"N/A\",\"N/A\",\"9.22\",\"5.85\",\"N/A\",\"11.52\",\"N/A\",\"N/A\",\"21.77\",\"N/A\",\"31.06\",\"1.52\",\"6.35\",\"N/A\",\"N/A\",\"N/A\",\"-13.91\",\"1.77\",\"N/A\",\"2.73\",\"N/A\",\"N/A\",\"-1.56\",\"N/A\",\"1.56\",\"N/A\",\"N/A\",\"9.39\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"12.44\",\"-13.90\",\"N/A\",\"-37.91\",\"N/A\",\"-12.02\",\"N/A\",\"N/A\",\"N/A\",\"4.81\",\"2.37\",\"N/A\",\"10.04\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"0.73\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"-2.77\",\"8.93\",\"8.11\",\"24.92\",\"N/A\",\"8.73\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"-15.36\",\"7.59\",\"N/A\",\"N/A\",\"N/A\",\"11.52\",\"-21.71\",\"N/A\",\"6.54\",\"10.79\",\"8.86\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\",\"N/A\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>N<\\/th>\\n      <th>종목명<\\/th>\\n      <th>현재가<\\/th>\\n      <th>전일비<\\/th>\\n      <th>등락률<\\/th>\\n      <th>거래량<\\/th>\\n      <th>거래대금<\\/th>\\n      <th>매수호가<\\/th>\\n      <th>매도호가<\\/th>\\n      <th>시가총액<\\/th>\\n      <th>PER<\\/th>\\n      <th>ROE<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":1},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"N\",\"targets\":1},{\"name\":\"종목명\",\"targets\":2},{\"name\":\"현재가\",\"targets\":3},{\"name\":\"전일비\",\"targets\":4},{\"name\":\"등락률\",\"targets\":5},{\"name\":\"거래량\",\"targets\":6},{\"name\":\"거래대금\",\"targets\":7},{\"name\":\"매수호가\",\"targets\":8},{\"name\":\"매도호가\",\"targets\":9},{\"name\":\"시가총액\",\"targets\":10},{\"name\":\"PER\",\"targets\":11},{\"name\":\"ROE\",\"targets\":12}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n:::\n\n## API의 활용\n\nKOSIS를 포함한 많은 대한민국의 데이터 포털은 개방 API 서비스를 제공하고 있다. KOSIS는 공유서비스 홈페이지([https://kosis.kr/openapi/](https://kosis.kr/openapi/index.jsp))를 통해 Open API를 통한 데이터 수집을 권장하고 있다.\n\n앞에서 설명한 것처럼, API용 패키지를 직접 사용할 수도 있지만, 래퍼 패키지가 존재하기만 한다면 그것을 활용하는 것이 훨씬 손쉬운 옵션일 수 있다. 놀랍게도 한국의 주석훈(Seokhoon Joo)이라는 분이 그러한 기능을 하는 `kosis`([https://cran.r-project.org/web/packages/kosis/index.html](https://cran.r-project.org/web/packages/kosis/))라는 패키지를 이미 개발해 두었고, 그것을 활용하고자 한다.\n\n실습 주제는 2024년 센서스 인구 기준으로 전국의 17개 시도별 '지방소멸위험지수'를 계산하고 그래프의 형태로 표현하는 것이다.\n\n### KOSIS에서 API KEY 받기\n\n먼저 API를 활용하기 위해 기관으로부터 KEY를 발급받아야 한다. 이를 위해 통계청에 회원가입을 한 후, KEY를 요청해야 한다. 과정은 아래와 같다.\n\n-   KOSIS 공유서비스 웹페이지(<https://kosis.kr/openapi/>) 접속\n\n-   상단의 \\[활용신청\\] 탭 클릭\n\n    -   통계청의 ONE-ID로 통합로그인(없으면 회원가입 필수)\n\n-   활용신청하여 사용자 인증키 획득\n\n    -   사용자 인증키는 마이페이지에서 언제든 확인 가능\n\n### 패키지 설치 및 인증키 등록\n\n우선 `kosis` 패키지를 오른쪽 하단 윈도우의 Packages 탭을 활용하여 인스톨한다. 이후에 아래와 같이 `kosis`와 `tidyverse` 패키지를 불러온다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(kosis)\n```\n:::\n\n\n다음으로, `kosis` 패키지의 [`kosis.setKey()`](https://rdrr.io/pkg/kosis/man/kosis.setKey.html) 함수를 이용하여 인증키를 등록한다. Your Key Here 자리에 부여받은 인증키를 붙여 넣는다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkosis.setKey(apiKey = \"Your Key Here\")\n```\n:::\n\n\n### 데이터 추출\n\n이제 통계청 홈페이지에 접속해서 데이터를 불러와본다. 과정은 아래와 같다.\n\n-   KOSIS에 접속 후 로그인\n\n-   데이터에 접근 후 URL 생성\n\n    -   \\[국내통계\\]-\\[주제별 통계\\]-\\[인구\\]-\\[인구총조사\\]-\\[인구부문\\]-\\[총조사인구(2015년 이후)\\]-\\[전수부문 (등록센서스, 2015년 이후)\\]-\\[전수기본표\\]-\\[연령 및 성별 인구\\]\n\n    -   **항목**: '총인구(명)', '총인구_남자(명)', '총인구_여자(명)'만 선택(더 많은 항목을 선택하면 데이터가 너무 커 에러가 발생)\n\n    -   **행정구역별(읍면동)**: '1 레벨'과 '2 레벨' 선택('1 레벨'은 시도 수준, '2 레벨'은 시군구 수준)\n\n    -   **조회기간**: '기간설정' 버튼을 누른 후, 기간설정이 2024\\~2024년인지 확인한다.\n\n    -   **응답필드**: 하나씩 눌러 모두 선택한 후, 'URL생성' 탭을 클릭한다. 그리고 나서 'URL 복사' 탭을 클릭한다. URL 속에 api key가 포함되어 있음을 확인한다.\n\n-   생성한 URL로부터 데이터 획득\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyour_url <- \"Your URL\"\ndata_api <- getStatDataFromURL(url = your_url)\n```\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\n`getStatDataFromURL` 함수의 아규먼트에 위에서 생성한 URL을 입력하면, 다운로드 과정 없이 곧바로 데이터를 획득할 수 있다.\n\n### 데이터 정리 및 변형\n\n아래와 같이 데이터를 정리 및 변형한다. 최종적으로 지역별 지역소멸위험지수를 산출한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data_api |> \n  select(C1, C1_NM, C2_NM, ITM_ID, DT) |> \n  # C1: 행정구역 코드 / C1_NM: 행정구역 이름 \n  # C2: 연령 코드 / C2_NM: 연령대\n  # ITM_ID: 성별 코드 / DT: 인구 수\n  mutate(\n    DT = na_if(DT, \"X\"),\n    across(c(C1, DT), as.numeric),\n    ITM_ID = case_match(\n    ITM_ID,\n    \"T00\" ~ \"T\",\n    \"T01\" ~ \"M\",\n    \"T02\" ~ \"F\"),\n  ) |>\n  unite(\"gender_age\", ITM_ID, C2_NM, sep = \"_\") |> \n  pivot_wider(\n    id_cols = c(C1, C1_NM),\n    names_from = gender_age,\n    values_from = DT\n  ) |> \n  mutate(\n    index = (`F_20~24세` + `F_25~29세` + `F_30~34세` + `F_35~39세`) / `T_65세이상`\n  ) |> \n  select(\n    C1, C1_NM, index\n  )\n```\n:::\n\n\n::: {.callout-note title=\"결측치 처리 함수\" collapse=\"true\"}\n[`na_if()`](https://dplyr.tidyverse.org/reference/na_if.html) 함수는 두 개의 인수를 받는데, 첫번째는 벡터(혹은 열), 두번째는 특정 값이다. 두 값을 받아 해당 열의 특정 값을 결측치로 바꾸는 역할을 한다. 여기서는 `DT` 열에 포함된 'X'라는 값을 결측치로 바꿔 분석에서 제외했다. 반대로, [`replace_na()`](https://tidyr.tidyverse.org/reference/replace_na.html)라는 함수는 이미 NA(결측치)로 되어 있는 값을 다른 값으로 채울 때 사용된다.\n:::\n\n시도 데이터와 시군구 데이터를 분리하여 저장한다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_sido <- data |> \n  filter(nchar(C1) == 2) \n\ndata_sgg <- data |> \n  filter(nchar(C1) == 5 & substr(C1, 5, 5) == 0 & !C1_NM %in% c(\"동부\", \"면부\", \"읍부\"))\n```\n:::\n\n\n### 그래프 작성\n\n인구소멸위험지수 연구에서 주로 사용되는 5개의 위험도 클래스의 구분법을 적용하고, 위험도 클래스별로 특정한 색상을 적용하고, 그래프의 범례에 5개의 클래스가 모두 나타나게 하려다보니 코드가 조금 복잡해졌다. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_sido <- data_sido |> \n  mutate(\n    index_class = case_when(\n      index < 0.2 ~ \"1\",\n      index >= 0.2 & index < 0.5 ~ \"2\",\n      index >= 0.5 & index < 1.0 ~ \"3\",\n      index >= 1.0 & index < 1.5 ~ \"4\",\n      index >= 1.5 ~ \"5\"\n    ),\n    index_class = factor(index_class, levels = as.character(1:5))\n  )\n\nclass_color <- c(\"1\" = \"#d7191c\", \"2\" = \"#fdae61\",\n                 \"3\" = \"#ffffbf\", \"4\" = \"#a6d96a\", \n                 \"5\" = \"#1a9641\")\ndata_sido |> \n  ggplot(aes(x = index, y = fct_reorder(C1_NM, index))) +\n  geom_col(aes(fill = index_class), show.legend = TRUE) +\n  geom_text(aes(label = format(round(index, digits = 3), \n                               nsmall = 3)), hjust = -0.1) +\n  scale_x_continuous(limits = c(0, 1.5)) +\n  scale_fill_manual(name = \"Classes\", \n                    labels = c(\"< 0.2\", \"0.2 ~ 0.5\", \"0.5 ~ 1.0\", \n                               \"1.0 ~ 1.5\", \">= 1.5\"), \n                    values = class_color, drop = FALSE) +\n  labs(title = \"인구소멸위험지수, 2024년\", \n       x = \"인구소멸위험지수\", \n       y = \"\")\n```\n\n::: {.cell-output-display}\n![](lab_08_2025_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n::: {.callout-tip collapse=\"false\"}\n## KOSIS API의 추가 예제\n\n이렇게 KOSIS 홈페이지에서 URL을 직접 지정하지 않고도 데이터를 불러오는 방법이 있다. `getStatData` 함수로, 기관명과 데이터 코드를 아규먼트에 입력하면 해당 데이터를 불러올 수 있다. 가령 방금 실습에서 사용한 데이터는 통계청의 2015년 인구총조사 전수부문의 연령 및 성별인구에 해당한다. 이때 통계청의 기관 코드는 [**101**]{.underline}, 해당 데이터의 코드는 [**DT_1IN503**]{.underline}이다.\n\n아래의 코드는 여기에 몇 개의 아규먼트를 더 추가하여 서울특별시 종로구의 2015년부터 2022년까지의 데이터를 불러오고, 이를 바탕으로 인구소멸지수를 계산하여 그 추이를 시각화 한 것이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\naoi_code <- \"11010\" # 서울특별시 종로구 코드\naoi <- getStatData(orgId = 101, tblId = \"DT_1IN1503\", prdSe = \"Y\",\n                    startPrdDe = \"2015\", endPrdDe = \"2024\",\n                    objL1 = aoi_code, objL2 = \"ALL\") |> \n  filter(nchar(C2) == 3)\n\naoi <- aoi |> \n  select(C1, C1_NM, C2, C2_NM, ITM_ID, ITM_NM, DT, PRD_DE) |> \n  filter(ITM_ID == \"T00\" | ITM_ID == \"T01\" | ITM_ID == \"T02\") |> \n  mutate(\n    DT = na_if(DT, \"X\"),\n    across(c(C1, DT), as.numeric),\n    ITM_ID = case_match(\n      ITM_ID, \"T00\" ~ \"T\",\n      \"T01\" ~ \"M\",\n      \"T02\" ~ \"F\"),\n  ) |> \n  unite(\"gender_age\", ITM_ID, C2_NM, sep = \"_\") |> \n  pivot_wider(\n    id_cols = c(C1, C1_NM, PRD_DE),\n    names_from = gender_age,\n    values_from = DT\n  ) |> \n  mutate(\n    index = (`F_20~24세` + `F_25~29세` + `F_30~34세` + `F_35~39세`) / `T_65세이상`\n  ) |> \n  select(\n    C1, C1_NM, index, PRD_DE\n  )\n\nregion <- aoi$C1_NM[1]\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naoi |> \n  ggplot(aes(x=PRD_DE, y=index)) +\n  geom_point() +\n  geom_line(group = 1, linewidth = 0.5) +\n  ggtitle(paste0(region, \" 인구소멸위험지수 추이\")) +\n  xlab(label = \"연도\") +\n  ylab(label = \"인구소멸위험지수\") +\n  theme(plot.title = element_text(size = 18, hjust=0.5))\n```\n\n::: {.cell-output-display}\n![](lab_08_2025_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n`aoi_code`에 내가 원하는 지역의 코드를 넣으면 마찬가지로 해당 관심지역의 인구소멸위험지수 추이를 관측할 수 있다. 예컨대 인구가 빠르게 증가하는 경기 김포시는 \"31230\", 화성시는 \"31240\"이고, 소멸지수가 가장 높은 경북 상주시는 \"37080\", 경북 문경시는 \"37090\"이다. 제공한 코드에서 한번 `aoi_code` 부분만 변경해보자.\n\n한편, 이렇게 URL 없이 데이터를 불러오는 경우 KOSIS에서 직접 조정하는 것에 비해 덜 번거롭지만 제한사항도 많다. 가령 복수의 지역을 불러오는 것이 반복문을 사용하지 않고서는 불가능하고, 불필요한 데이터를 빼고 가져오기도 어렵다. 그러나 startPrdDe와 endPrdDe 아규먼트를 이용해 데이터를 시계열로 수집하고자 하는 측면에서는 유용하다.\n\n그러므로 수집하고자 하는 데이터를 잘 파악해서 API를 활용해보자.\n:::\n\n### cf) KOSIS API를 활용한 함수 작성\n\n마지막으로, API를 활용한 함수를 소개한다. API를 신청할 때 보았듯, 이는 웹/앱 애플리케이션을 제작하기 위한 용도로 주로 사용된다.\n\n이와 관련된 매우 간단한 예시로, 학생에게 인구소멸지수가 궁금한 지역을 검색해보도록 하는 활동을 구상한다고 가정해보자. 학생이 매번 코드를 작성하며 확인하기란 사실상 불가능하다. 그런데 위에서 사용한 코드와 API를 활용하면 함수를 어렵지 않게 생성할 수 있다.\n\n예컨대 교사가 아래와 같이 `exInd()` 함수를 한번 작성해두면, 학생은 단 한 줄의 코드만 입력해도 금방 지역의 인구소멸지수의 추이를 탐색해볼 수 있을 것이다.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 함수 생성: 교사 작성 부분\nexInd <- function(){\n  # Library\n  library(tidyverse)\n  library(kosis)\n  library(DT)\n  library(openxlsx)\n  \n  # Table for Searching Region Code\n  region_table <- read.xlsx(\"https://github.com/Sechang-Kim/gis-lab/raw/download/korea-sigungu-code(2022).xlsx\")\n  print(datatable(region_table))\n  \n  # Input Arguments\n  aoi_code <- readline('지역 코드를 입력하세요: ')\n  start <- as.numeric(readline('시작 연도를 입력하세요: '))\n  end <- as.numeric(readline('종료 연도를 입력하세요: '))\n  \n  # Data Request\n  aoi <- getStatData(orgId = 101, tblId = \"DT_1IN1503\", prdSe = \"Y\",\n                     startPrdDe = start, endPrdDe = end,\n                     objL1 = aoi_code, objL2 = \"ALL\") |> \n    filter(nchar(C2) == 3) # Delete 1-age interval(Only 5-age interval)\n  \n  # Data Cleansing\n  aoi <- aoi |> \n    select(C1, C1_NM, C2, C2_NM, ITM_ID, ITM_NM, DT, PRD_DE) |> \n    filter(ITM_ID == \"T00\" | ITM_ID == \"T01\" | ITM_ID == \"T02\") |> \n    mutate(\n      DT = na_if(DT, \"X\"),\n      across(c(C1, DT), as.numeric),\n      ITM_ID = case_match(\n        ITM_ID, \"T00\" ~ \"T\",\n        \"T01\" ~ \"M\",\n        \"T02\" ~ \"F\"),\n    ) |> \n    unite(\"gender_age\", ITM_ID, C2_NM, sep = \"_\") |> \n    pivot_wider(\n      id_cols = c(C1, C1_NM, PRD_DE),\n      names_from = gender_age,\n      values_from = DT\n    ) |> \n    mutate(\n      index = (`F_20~24세` + `F_25~29세` + `F_30~34세` + `F_35~39세`) / `T_65세이상`\n    ) |> \n    select(\n      C1, C1_NM, index, PRD_DE\n    )\n  \n  ## Visualization\n  region <- aoi$C1_NM[1] # For Auto-Plot Title\n  vis <- aoi |> \n    ggplot(aes(x=PRD_DE, y=index)) +\n    geom_point() +\n    geom_line(group = 1, linewidth = 0.5) +\n    ggtitle(paste0(region, \" 인구소멸위험지수 추이\")) +\n    xlab(label = \"연도\") +\n    ylab(label = \"인구소멸위험지수\") +\n    theme(plot.title = element_text(size = 18, hjust=0.5))\n  \n  return(vis)\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 함수 실행: 학생 작성 부분\nexInd()\n```\n:::\n\n",
    "supporting": [
      "lab_08_2025_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/datatables-binding-0.33/datatables.js\"></script>\n<script src=\"site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}